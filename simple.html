<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—É—Å—Ç–æ–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä - –ê—Ä–∞–±—Å–∫–∏–µ —Å–ª–æ–≤–∞</title>
  <script src="dua.js"></script>
  <script src="theme.js"></script>
  <link rel="stylesheet" href="theme.css">
  <script src="service-worker-register.js"></script>
  <script src="sidebar-menu.js"></script>
  <script src="favorites.js"></script>
  <script src="streak.js"></script>
  <script defer src="https://cloud.umami.is/script.js" data-website-id="c36890d7-f350-4f42-acbf-0fae5d376929"></script>
  
  <style>
    body { background: #fff; color: #000; font-family: Arial, sans-serif; margin: 20px; }
    #main { max-width: 900px; margin: auto; }
    .hidden { display: none !important; }
    .button { padding: 10px 16px; margin: 8px; font-size: 1em; cursor: pointer; }
    #progress { margin-top: 12px; font-size: 1.1em; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–ª–æ–≤–∞ */
    .word-card {
      position: relative;
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 35px 25px;
      margin: 20px 0;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.4s ease;
      overflow: visible;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .word-card-arabic {
      font-size: 32px;
      font-family: 'Amiri', 'Traditional Arabic', serif;
      color: #1a1a2e;
      line-height: 2.4;
      margin-bottom: 15px;
      direction: rtl;
      text-align: center;
      word-spacing: 8px;
      padding: 18px 10px 8px 10px;
      overflow: visible;
      display: inline-block;
    }

    .word-card-translation {
      font-size: 18px;
      color: #4b5563;
      line-height: 1.6;
    }

    .word-card-hidden .word-card-translation {
      display: none;
    }

    /* –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥ (–≥–ª–∞–∑–æ–∫) */
    .show-translation-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .show-translation-btn:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: scale(1.1);
    }

    .show-translation-btn:active {
      transform: scale(0.95);
    }

    .show-translation-btn.active {
      background: rgba(102, 126, 234, 0.3);
    }

    @media (max-width:480px) {
      .modal { padding: 12px; }
      .modal h2 { font-size: 20px; }
      .modal .answer { font-size: 18px; }
      .word-card {
        padding: 28px 16px;
        min-height: 150px;
      }
      .word-card-arabic {
        font-size: 26px;
        line-height: 2.5;
        padding: 16px 12px 8px 12px;
      }
      .word-card-translation {
        font-size: 16px;
      }
    }

    #correct-list, #mistake-list { max-height: 160px; overflow-y: auto; background: #fafafa; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    textarea { width: 100%; height: 150px; font-size: 1em; }
    input[type="text"] { width: 60%; font-size: 1em; padding: 6px; }
    
    #loader { background: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    #loader h2 { font-size: 1.3em; margin-bottom: 10px; }
    #loader p { font-size: 0.95em; color: #666; margin-bottom: 10px; }

    .overlay { position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); display:flex; align-items: center; justify-content: center; z-index: 10000; }
    .modal { background: #fff; width: 760px; max-width: 95%; border-radius: 8px; box-shadow: 0 6px 30px rgba(0,0,0,0.25); padding: 18px 20px; box-sizing: border-box; }
    .modal h2 { font-size: 26px; margin: 0 0 8px 0; font-weight: 700; }
    .modal .label { font-size: 16px; margin-bottom: 6px; color: #222; }
    .modal .row { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .modal .left { flex: 0 0 auto; width: 48%; text-align: left; }
    .modal .right { flex: 1 1 auto; text-align: right; direction: rtl; }
    .modal .answer { font-weight: 700; font-size: 20px; }
    .modal .controls { display:flex; justify-content:flex-end; margin-top: 14px; }
    .close-btn { background:#f4f4f4; color:#222; border:1px solid #bfbfbf; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:14px; }

    .oral-btn {
      background: #e8f5e9;
      border: 1px solid #81c784;
    }
    .oral-btn:hover { background: #c8e6c9; }

    .forgot-btn {
      background: #ffebee;
      border: 1px solid #e57373;
    }
    .forgot-btn:hover { background: #ffcdd2; }

    .copy-btn {
      background: #e3f2fd;
      border: 1px solid #64b5f6;
      padding: 6px 12px;
      font-size: 0.9em;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 8px;
    }
    .copy-btn:hover { background: #bbdefb; }

    .copy-success {
      color: #4caf50;
      font-size: 0.9em;
      margin-left: 8px;
    }

  </style>
</head>
<body>
  <div id="main">
    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ —Å–ª–æ–≤ -->
    <div id="loader">
      <h2>–ü—É—Å—Ç–æ–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä</h2>
      <p>–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤ (—Ñ–æ—Ä–º–∞—Ç: —Ä—É—Å—Å–∫–∏–π - –∞—Ä–∞–±—Å–∫–∏–π, –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</p>
      <textarea id="word-list" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:&#10;–ê–ª–ª–∞—Ö - ÿßŸÑŸÑŸá&#10;–ì–æ—Å–ø–æ–¥—å - ÿßŸÑÿ±ŸéŸëÿ®Ÿë&#10;–º–∏–ª–æ—Å—Ç–∏–≤—ã–π - ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜ"></textarea>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
        <button id="load-list" class="button">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        <button id="load-favorites" class="button" style="background:#fff8e1;border-color:#ffc107;">‚≠ê –î–æ–±–∞–≤–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</button>
      </div>
      <p id="fav-count-hint" style="font-size:0.85em;color:#888;margin-top:8px;"></p>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç–∞ -->
    <div id="controls" class="hidden">
      <button id="start-all" class="button">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
    </div>

    <!-- –°–∞–º —Ç—Ä–µ–Ω–∞–∂—ë—Ä -->
    <div id="trainer" class="hidden">
      <div id="progress"></div>
      
      <div class="word-card word-card-hidden" id="wordCard">
        <button class="show-translation-btn" id="showTranslationBtn" onclick="toggleTranslation()" onmousedown="event.preventDefault()" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥">
          üëÅÔ∏è
        </button>
        <div class="word-card-arabic" id="arabic-word"></div>
        <div class="word-card-translation" id="word-translation"></div>
      </div>
      
      <input type="text" id="answer-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥" autofocus>
      <button id="submit-answer" class="button">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
      <button id="oral-answer" class="button oral-btn">–û—Ç–≤–µ—Ç–∏–ª —É—Å—Ç–Ω–æ</button>
      <button id="forgot-answer" class="button forgot-btn">–Ø –∑–∞–±—ã–ª</button>

      <h3>–ü—Ä–∞–≤–∏–ª—å–Ω–æ:</h3>
      <div id="correct-list"></div>

      <h3>–û—à–∏–±–∫–∏:</h3>
      <div id="mistake-list"></div>
      <div id="copy-mistakes-container" class="hidden">
        <button id="copy-mistakes" class="copy-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏</button>
        <span id="copy-success" class="copy-success hidden">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>
      </div>

      <div id="after-session" class="hidden">
        <button id="retry-all" class="button">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
        <button id="start-mistakes" class="button hidden">–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏</button>
      </div>
    </div>
  </div>

  <!-- root –¥–ª—è –º–æ–¥–∞–ª–∫–∏ -->
  <div id="modal-root"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let allWords = [], sessionWords = [], mistakes = [], mistakeLines = [], total = 0, currentIndex = 0;
      let modalTimer = null;

      // ========== localStorage –∫–ª—é—á–∏ ==========
      const WORDS_STORAGE_KEY = 'simpleTrainerWords';
      const SESSION_STORAGE_KEY = 'simpleTrainerSession';

      // ========== –§—É–Ω–∫—Ü–∏–∏ localStorage ==========
      
      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
      function saveWordList(text) {
        try {
          localStorage.setItem(WORDS_STORAGE_KEY, text);
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤', e);
        }
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
      function loadWordList() {
        try {
          return localStorage.getItem(WORDS_STORAGE_KEY) || '';
        } catch (e) {
          return '';
        }
      }

      // –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
      function clearWordList() {
        try {
          localStorage.removeItem(WORDS_STORAGE_KEY);
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤', e);
        }
      }

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
      function saveSession() {
        if (sessionWords.length === 0) return;
        
        try {
          const sessionData = {
            allWords: allWords,
            sessionWords: sessionWords,
            currentIndex: currentIndex,
            mistakes: mistakes,
            mistakeLines: mistakeLines,
            total: total,
            timestamp: Date.now()
          };
          localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessionData));
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é', e);
        }
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é
      function loadSession() {
        try {
          const saved = localStorage.getItem(SESSION_STORAGE_KEY);
          return saved ? JSON.parse(saved) : null;
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é', e);
          return null;
        }
      }

      // –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é
      function clearSession() {
        try {
          localStorage.removeItem(SESSION_STORAGE_KEY);
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é', e);
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
      function showResumeModal(session) {
        const root = document.getElementById('modal-root');
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        const progress = `${session.currentIndex + 1} –∏–∑ ${session.total}`;
        const mistakesCount = session.mistakes ? session.mistakes.length : 0;
        
        modal.innerHTML = 
          '<h2>üìö –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–µ—Å—Å–∏—é?</h2>' +
          '<div class="label" style="margin-bottom:15px;">' +
          '–ù–∞–π–¥–µ–Ω–∞ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:<br>' +
          '<strong>–°–ª–æ–≤–æ ' + progress + '</strong>, –æ—à–∏–±–æ–∫: ' + mistakesCount +
          '</div>' +
          '<div class="controls" style="gap:10px;flex-wrap:wrap;">' +
          '<button id="resume-session-btn" class="close-btn" style="background:#e8f5e9;border-color:#81c784;">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>' +
          '<button id="restart-session-btn" class="close-btn" style="background:#ffebee;border-color:#e57373;">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>' +
          '<button id="postpone-session-btn" class="close-btn" style="background:#f3f4f6;border-color:#d1d5db;">‚è∞ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∑–∂–µ</button>' +
          '</div>';
        
        overlay.appendChild(modal);
        root.appendChild(overlay);

        document.getElementById('resume-session-btn').addEventListener('click', function() {
          root.innerHTML = '';
          resumeSession(session);
        });

        document.getElementById('restart-session-btn').addEventListener('click', function() {
          root.innerHTML = '';
          clearSession();
          clearWordList();
          // –û—á–∏—â–∞–µ–º textarea
          wordListTextarea.value = '';
          // –ü–æ–∫–∞–∑–∞—Ç—å loader
          loader.classList.remove('hidden');
          trainer.classList.add('hidden');
        });

        document.getElementById('postpone-session-btn').addEventListener('click', function() {
          root.innerHTML = '';
          // –ü—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ, —Å–µ—Å—Å–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –≤ localStorage
          // –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∂–µ—Ç—Å—è —ç—Ç–æ –æ–∫–Ω–æ
        });
      }

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é
      function resumeSession(session) {
        allWords = session.allWords;
        sessionWords = session.sessionWords;
        currentIndex = session.currentIndex;
        mistakes = session.mistakes || [];
        mistakeLines = session.mistakeLines || [];
        total = session.total;

        loader.classList.add('hidden');
        controls.classList.add('hidden');
        trainer.classList.remove('hidden');
        submitBtn.disabled = false;
        oralBtn.disabled = false;
        forgotBtn.disabled = false;
        afterSession.classList.add('hidden');
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏ –æ—à–∏–±–æ–∫
        correctListDiv.innerHTML = '';
        mistakeListDiv.innerHTML = '';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
        mistakeLines.forEach(function(line) {
          mistakeListDiv.innerHTML += '<div>' + escapeHtml(line) + '</div>';
        });
        if (mistakeLines.length > 0) {
          copyMistakesContainer.classList.remove('hidden');
        }

        nextWord();
      }

      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      function checkSavedSession() {
        const session = loadSession();
        if (session && session.sessionWords && session.sessionWords.length > 0 && session.currentIndex < session.total) {
          showResumeModal(session);
        }
      }

      const loader = document.getElementById('loader');
      const controls = document.getElementById('controls');
      const trainer = document.getElementById('trainer');
      const wordListTextarea = document.getElementById('word-list');
      const loadListBtn = document.getElementById('load-list');
      const startAllBtn = document.getElementById('start-all');
      const retryAllBtn = document.getElementById('retry-all');
      const startMistakesBtn = document.getElementById('start-mistakes');
      const arabicWordH2 = document.getElementById('arabic-word');
      const progressDiv = document.getElementById('progress');
      const answerInput = document.getElementById('answer-input');
      const submitBtn = document.getElementById('submit-answer');
      const oralBtn = document.getElementById('oral-answer');
      const forgotBtn = document.getElementById('forgot-answer');
      const correctListDiv = document.getElementById('correct-list');
      const mistakeListDiv = document.getElementById('mistake-list');
      const afterSession = document.getElementById('after-session');
      const copyMistakesContainer = document.getElementById('copy-mistakes-container');
      const copyMistakesBtn = document.getElementById('copy-mistakes');
      const copySuccess = document.getElementById('copy-success');

      loadListBtn.addEventListener('click', function() {
        const text = wordListTextarea.value.trim();
        if (!text) {
          alert('–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤');
          return;
        }
        parseText(text);
        if (allWords.length === 0) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–ª–æ–≤–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç.');
          return;
        }
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
        saveWordList(text);
        loader.classList.add('hidden');
        startSession(false);
      });

      // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      const loadFavoritesBtn = document.getElementById('load-favorites');
      const favCountHint = document.getElementById('fav-count-hint');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
      function updateFavHint() {
        const count = typeof getFavoritesCount === 'function' ? getFavoritesCount() : 0;
        if (count > 0) {
          favCountHint.textContent = `‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º: ${count} —Å–ª–æ–≤`;
        } else {
          favCountHint.textContent = '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤';
        }
      }
      updateFavHint();

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
      const savedWordList = loadWordList();
      if (savedWordList) {
        wordListTextarea.value = savedWordList;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
      checkSavedSession();
      
      loadFavoritesBtn.addEventListener('click', function() {
        const favText = typeof getFavoritesAsText === 'function' ? getFavoritesAsText() : '';
        if (!favText) {
          alert('–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤. –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–ª–æ–≤–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ç—Ä–µ–Ω–∞–∂–µ—Ä–æ–≤.');
          return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ç–µ–∫—Å—Ç—É
        const current = wordListTextarea.value.trim();
        if (current) {
          wordListTextarea.value = current + '\n' + favText;
        } else {
          wordListTextarea.value = favText;
        }
        
        alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${getFavoritesCount()} —Å–ª–æ–≤ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ!`);
      });

      function parseText(text) {
        allWords = text.split(/\r?\n/).map(function(l) { return l.trim(); }).filter(function(l) { return l; }).map(function(line) {
          const sep = line.search(/[-‚Äì‚Äî]/);
          const rus = sep !== -1 ? line.slice(0, sep).trim() : '';
          const arab = sep !== -1 ? line.slice(sep + 1).trim() : '';
          const rusVars = rus.split(',').map(function(r) { return r.trim().toLowerCase(); });
          return { 
            arabicFull: arab, 
            rusVariants: rusVars, 
            originalLine: line
          };
        });
      }

      function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
      }

      function startSession(useMistakes) {
        if (!useMistakes) {
          mistakes = [];
          mistakeLines = [];
          startMistakesBtn.classList.add('hidden');
          sessionWords = allWords.slice();
        } else {
          sessionWords = mistakes.slice();
          mistakes = [];
          mistakeLines = [];
        }
        shuffle(sessionWords);
        total = sessionWords.length;
        currentIndex = 0;
        correctListDiv.innerHTML = '';
        mistakeListDiv.innerHTML = '';
        copyMistakesContainer.classList.add('hidden');
        controls.classList.add('hidden');
        trainer.classList.remove('hidden');
        submitBtn.disabled = false;
        oralBtn.disabled = false;
        forgotBtn.disabled = false;
        afterSession.classList.add('hidden');
        nextWord();
        saveSession(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
      }

      startAllBtn.addEventListener('click', function() { startSession(false); });
      startMistakesBtn.addEventListener('click', function() { if (mistakes.length) startSession(true); });
      retryAllBtn.addEventListener('click', function() { clearSession(); startSession(false); });

      // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥
      function toggleTranslation() {
        const card = document.getElementById('wordCard');
        const btn = document.getElementById('showTranslationBtn');
        
        if (card.classList.contains('word-card-hidden')) {
          card.classList.remove('word-card-hidden');
          btn.classList.add('active');
          btn.title = '–°–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
        } else {
          card.classList.add('word-card-hidden');
          btn.classList.remove('active');
          btn.title = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
        setTimeout(function() {
          answerInput.focus();
        }, 10);
      }

      // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–∫–∞–∑–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
      function resetTranslationButton() {
        const card = document.getElementById('wordCard');
        const btn = document.getElementById('showTranslationBtn');
        card.classList.add('word-card-hidden');
        btn.classList.remove('active');
        btn.title = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
      }

      // –î–µ–ª–∞–µ–º toggleTranslation –≥–ª–æ–±–∞–ª—å–Ω–æ–π
      window.toggleTranslation = toggleTranslation;

      function nextWord() {
        if (currentIndex >= total) {
          progressDiv.textContent = '–ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–π–¥–µ–Ω–æ ' + total + '/' + total + ', –æ—à–∏–±–æ–∫: ' + mistakes.length;
          submitBtn.disabled = true;
          oralBtn.disabled = true;
          forgotBtn.disabled = true;
          if (mistakes.length) {
            startMistakesBtn.classList.remove('hidden');
            copyMistakesContainer.classList.remove('hidden');
          }
          afterSession.classList.remove('hidden');
          clearSession(); // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
          return;
        }
        const it = sessionWords[currentIndex];
        arabicWordH2.textContent = it.arabicFull;
        document.getElementById('word-translation').textContent = it.rusVariants.join(', ');
        resetTranslationButton();
        progressDiv.textContent = (currentIndex + 1) + '/' + total + ' —Å–ª–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ‚Äì ' + mistakes.length + ' –æ—à–∏–±–æ–∫';
        answerInput.value = '';
        answerInput.focus();
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
        const card = document.getElementById('wordCard');
        card.style.animation = 'none';
        card.offsetHeight; // Trigger reflow
        card.style.animation = 'fadeIn 0.4s ease';
      }

      function addMistake(it) {
        mistakes.push(it);
        mistakeLines.push(it.originalLine);
        mistakeListDiv.innerHTML += '<div>' + escapeHtml(it.originalLine) + '</div>';
        if (mistakes.length > 0) {
          copyMistakesContainer.classList.remove('hidden');
        }
      }

      function showWrongModal(arabicText, ruText, onClose) {
        closeModal();
        const root = document.getElementById('modal-root');
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = '<h2>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</h2>' +
          '<div class="label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</div>' +
          '<div class="row">' +
          '<div class="left"></div>' +
          '<div class="right"><span class="answer">' + escapeHtml(arabicText) + ' - ' + escapeHtml(ruText) + '</span></div>' +
          '</div>' +
          '<div class="controls">' +
          '<button id="modal-close-btn" class="close-btn">–ó–∞–∫—Ä—ã—Ç—å (Esc)</button>' +
          '</div>';
        overlay.appendChild(modal);
        root.appendChild(overlay);

        function cleanup() {
          if (modalTimer) { clearTimeout(modalTimer); modalTimer = null; }
          document.removeEventListener('keydown', onKey);
          if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
        }

        function onKey(e) {
          if (e.key === 'Escape') { cleanup(); if (onClose) onClose(); }
        }

        document.addEventListener('keydown', onKey);
        document.getElementById('modal-close-btn').addEventListener('click', function() {
          cleanup();
          if (onClose) onClose();
        });

        modalTimer = setTimeout(function() { cleanup(); if (onClose) onClose(); }, 17000);
      }

      function closeModal() {
        const root = document.getElementById('modal-root');
        root.innerHTML = '';
        if (modalTimer) { clearTimeout(modalTimer); modalTimer = null; }
      }

      function escapeHtml(s) {
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      function handleAnswer() {
        const it = sessionWords[currentIndex];
        let ans = answerInput.value.trim().toLowerCase();
        if (!ans) return;
        const norm = ans.replace(/–µ/g, '—ë');
        const ok = it.rusVariants.some(function(v) { return v === ans || v === norm; });
        if (ok) {
          correctListDiv.innerHTML += '<div>' + escapeHtml(it.originalLine) + '</div>';
          if(typeof recordWordAnswer === 'function') recordWordAnswer(); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–ª—è —Å–µ—Ä–∏–∏ –¥–Ω–µ–π
          currentIndex++;
          saveSession();
          nextWord();
        } else {
          addMistake(it);
          const corr = it.rusVariants.join(', ');
          showWrongModal(it.arabicFull, corr, function() { currentIndex++; saveSession(); nextWord(); });
        }
      }

      function handleOralAnswer() {
        const it = sessionWords[currentIndex];
        correctListDiv.innerHTML += '<div>' + escapeHtml(it.originalLine) + '</div>';
        if(typeof recordWordAnswer === 'function') recordWordAnswer(); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–ª—è —Å–µ—Ä–∏–∏ –¥–Ω–µ–π
        currentIndex++;
        saveSession();
        nextWord();
      }

      function handleForgotAnswer() {
        const it = sessionWords[currentIndex];
        addMistake(it);
        currentIndex++;
        saveSession();
        nextWord();
      }

      copyMistakesBtn.addEventListener('click', function() {
        const textToCopy = mistakeLines.join('\n');
        navigator.clipboard.writeText(textToCopy).then(function() {
          copySuccess.classList.remove('hidden');
          setTimeout(function() {
            copySuccess.classList.add('hidden');
          }, 2000);
        }).catch(function() {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
        });
      });

      submitBtn.addEventListener('click', handleAnswer);
      oralBtn.addEventListener('click', handleOralAnswer);
      forgotBtn.addEventListener('click', handleForgotAnswer);
      answerInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); handleAnswer(); }
      });
    });
  </script>
</body>
</html>
