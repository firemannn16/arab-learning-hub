<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ó–∞—É—á–∫–∞ + –ü—Ä–∞–∫—Ç–∏–∫–∞ - –ê—Ä–∞–±—Å–∫–∏–µ —Å–ª–æ–≤–∞</title>
    <script src="dua.js"></script>
    <script src="service-worker-register.js"></script>
    <script src="storage-protection.js"></script>
<script type="module">
/* ========== ‚úÖ –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¢–û–† –¢–†–ï–ù–ê–ñ–ï–†–ê ========== */
const TRAINER_ID = 'input';

/* ========== ‚úÖ –ü–†–ï–§–ò–ö–° –î–õ–Ø –≠–¢–û–ì–û –¢–†–ï–ù–ê–ñ–ï–†–ê ========== */
const PREFIX = 'input_';

/* ========== ‚úÖ –û–ë–©–ò–ô –ö–û–î –î–õ–Ø –í–°–ï–• –¢–†–ï–ù–ê–ñ–ï–†–û–í ========== */
const SHARED_CODE_KEY = 'userProgressCode';

/* ---------- Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---------- */
const firebaseConfig = {
    apiKey: "AIzaSyCYm7d5ihMS9u0z_hq-1JG7TKrZvXzQZYk",
    authDomain: "–∞—Ä–∞–±—Å–∫–∏–π-e3be6.firebaseapp.com",
    databaseURL: "https://–∞—Ä–∞–±—Å–∫–∏–π-e3be6-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "–∞—Ä–∞–±—Å–∫–∏–π-e3be6",
    storageBucket: "–∞—Ä–∞–±—Å–∫–∏–π-e3be6.firebasestorage.app",
    messagingSenderId: "531088407371",
    appId: "1:531088407371:web:e1fd3e7e2cf33ee4f29c4a"
};
try {
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
  const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
  window.firebaseApp = initializeApp(firebaseConfig);
  window.firestore = getFirestore(window.firebaseApp);
  window.firebaseEnabled = true;
  window.firebaseModules = { doc: null, setDoc: null, getDoc: null, deleteDoc: null };
  const firestoreModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
  window.firebaseModules.doc = firestoreModule.doc;
  window.firebaseModules.setDoc = firestoreModule.setDoc;
  window.firebaseModules.getDoc = firestoreModule.getDoc;
  window.firebaseModules.deleteDoc = firestoreModule.deleteDoc;
  console.log('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
} catch(e) {
  console.warn('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', e);
  window.firebaseEnabled = false;
}

/* ========== ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ ========== */
function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

function getUserCode() {
  // ‚úÖ –ß–∏—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é (–∫–æ–¥ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ index.html)
  let code = null;
  try {
    code = localStorage.getItem(SHARED_CODE_KEY);
  } catch(e) {
    console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–¥–∞:', e);
  }
  
  if (!code) {
    code = generateCode();
    try {
      localStorage.setItem(SHARED_CODE_KEY, code);
    } catch(e) {
      console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–¥–∞:', e);
    }
    console.log('üÜï –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–¥:', code);
  }
  return code;
}

const USER_CODE = getUserCode();

/* ---------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---------- */
const BATCH_SIZE = 33;
const SHOW_ANSWER_MS = 15000;

/* ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---------- */
let allWords = [];
let orderQueue = [];
let masteredFinal = [];
let practiceHistory = [];
let roundMastered = [];
let practiceAccum = [];
let practiceOrder = [];
let phase = 'learn';
let currentRaw = null;
let modalTimer = null;

/* ---------- DOM ---------- */
const screenMain = document.getElementById('screen-main');
const statTotal = document.getElementById('stat-total');
const statMastered = document.getElementById('stat-mastered');
const statRemaining = document.getElementById('stat-remaining');
const statPhase = document.getElementById('stat-phase');
const arabicDiv = document.getElementById('arabic');
const learnControls = document.getElementById('learn-controls');
const btnKnow = document.getElementById('btn-know');
const btnDont = document.getElementById('btn-dont');
const btnAdd = document.getElementById('btn-add');
const btnReset = document.getElementById('btn-reset');
const messageDiv = document.getElementById('message');
const practiceArea = document.getElementById('practice-area');
const practiceInput = document.getElementById('practice-input');
const practiceSubmit = document.getElementById('practice-submit');
const practiceSkip = document.getElementById('practice-skip');
const oralAnswerBtn = document.getElementById('oral-answer');
const modalRoot = document.getElementById('modal-root');

/* ---------- –£—Ç–∏–ª–∏—Ç—ã ---------- */
function normalizeRu(s){
  if(!s && s!=='') return '';
  return String(s).trim().toLowerCase().replace(/—ë/g,'–µ').replace(/\s+/g,' ');
}
function normalizeLine(l){ if(!l) return ''; return l.replace(/^\uFEFF/,'').replace(/[\u2010\u2011\u2012\u2013\u2014\u2015‚Äì‚Äî‚àí]/g,'-').replace(/\s+/g,' ').trim(); }
function parseLine(raw){
  raw = normalizeLine(raw);
  const parts = raw.split(/[-‚Äì‚Äî]/).map(p=>p.trim()).filter(Boolean);
  const left = parts.length ? parts[0] : '';
  const right = parts.slice(1);
  const rus = left ? left.split(',').map(s=>s.trim()).filter(Boolean) : [];
  const arabParts = right.length ? right.join(' - ').split(/\s*-\s*/).map(s=>s.trim()).filter(Boolean) : [];
  return { rawLine: raw, rus, arabParts, arabFull: right.join(' - ') || '' };
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

/* ---------- last-letter mistake detector ---------- */
function isLastCharMistake(userRaw, correctRaw){
  const u = normalizeRu(userRaw||'');
  const c = normalizeRu(correctRaw||'');
  if(!u || !c) return false;
  if(u === c) return false;
  if(u.length === c.length){
    if(u.slice(0, -1) === c.slice(0, -1) && u[u.length-1] !== c[c.length-1]) return true;
  }
  if(u.length === c.length - 1){
    if(u === c.slice(0, -1)) return true;
  }
  if(u.length === c.length + 1){
    if(u.slice(0, -1) === c) return true;
  }
  return false;
}

/* ========== ‚úÖ Save / Load / Clear (–ü–û–î–ö–û–õ–õ–ï–ö–¶–ò–Ø) ========== */
async function saveState(){
  const st = {
    trainerId: TRAINER_ID,
    code: USER_CODE,
    allRaw: allWords.map(w=>w.rawLine),
    orderQueue: orderQueue.slice(),
    masteredFinal: masteredFinal.slice(),
    practiceHistory: practiceHistory.slice(),
    roundMastered: roundMastered.slice(),
    practiceAccum: practiceAccum.slice(),
    practiceOrder: practiceOrder.slice(),
    phase, currentRaw,
    timestamp: Date.now()
  };
  
  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase (–ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏—è) + backup –≤ localStorage
  if(window.firebaseEnabled && window.firestore && window.firebaseModules){
    await safeFirebaseSave(
      async () => {
        const docRef = window.firebaseModules.doc(
          window.firestore, 
          'users', USER_CODE, 
          'trainers', TRAINER_ID
        );
        return await window.firebaseModules.setDoc(docRef, st, { merge: true });
      },
      PREFIX + 'state',
      st
    );
    console.log('‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Firestore (input)');
  } else {
    // Fallback: —Ç–æ–ª—å–∫–æ localStorage
    safeLocalStorageSet(PREFIX + 'state', st);
  }
}

async function loadState(){
  // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º safeFirebaseLoad (Firebase + fallback localStorage)
  if(window.firebaseEnabled && window.firestore && window.firebaseModules){
    const firebaseData = await safeFirebaseLoad(
      async () => {
        const docRef = window.firebaseModules.doc(
          window.firestore, 
          'users', USER_CODE, 
          'trainers', TRAINER_ID
        );
        const docSnap = await window.firebaseModules.getDoc(docRef);
        if(docSnap.exists()){
          console.log('‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Firestore (input)');
          return docSnap.data();
        }
        return null;
      },
      PREFIX + 'state'
    );
    
    // ‚úÖ –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º timestamp: –ª–æ–∫–∞–ª—å–Ω—ã–µ VS Firebase
    const localData = safeLocalStorageGet(PREFIX + 'state', 0);
    
    if (firebaseData && localData) {
      const firebaseTime = firebaseData.timestamp || 0;
      const localTime = localData.timestamp || 0;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
      if (localTime > firebaseTime) {
        console.log('üì± –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–µ (input), —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ Firebase...');
        await saveState();
        return localData;
      } else {
        console.log('‚òÅÔ∏è Firebase –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–µ (input)');
        return firebaseData;
      }
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ Firebase –¥–∞–Ω–Ω—ã–µ
    if (firebaseData) {
      return firebaseData;
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (localData) {
      return localData;
    }
  }
  
  // Fallback: —Ç–æ–ª—å–∫–æ localStorage
  return safeLocalStorageGet(PREFIX + 'state', 0);
}

async function clearState(){
  // ‚úÖ –£–¥–∞–ª—è–µ–º –∏–∑ localStorage
  try{
    localStorage.removeItem(PREFIX + 'state');
    localStorage.removeItem(PREFIX + 'state_backup');
    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö backup'–æ–≤
    cleanOldBackups(0);
  }catch(e){}
  
  // ‚úÖ –£–¥–∞–ª—è–µ–º –∏–∑ Firebase (–ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏—è) —Å retry
  if(window.firebaseEnabled && window.firestore && window.firebaseModules){
    await safeFirebaseOperation(
      async () => {
        const docRef = window.firebaseModules.doc(
          window.firestore, 
          'users', USER_CODE, 
          'trainers', TRAINER_ID
        );
        await window.firebaseModules.deleteDoc(docRef);
        console.log('‚úì –£–¥–∞–ª–µ–Ω–æ –∏–∑ Firestore (input)');
      },
      '–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (input)',
      2
    );
  }
}

/* ---------- robust fetch ---------- */
async function robustFetchWords(){
  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å retry
  return await safeLoadWordsFile('words.txt', 3);
}

/* ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ–≤–∞—Ä—è ---------- */
async function initDictionary(){
  const st = await loadState();
  let serverWords = [];
  let serverWordsByRaw = new Map();
  let serverRawSet = new Set();
  try{
    const txt = await robustFetchWords();
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    serverWords = lines.map(parseLine);
    serverWords.forEach(w => {
      serverWordsByRaw.set(w.rawLine, w);
      serverRawSet.add(w.rawLine);
    });
  }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å words.txt:', e); }
  if(st && Array.isArray(st.allRaw) && st.allRaw.length){
    allWords = st.allRaw.map(raw => {
      const parsed = parseLine(raw);
      return { rawLine: raw, ...parsed };
    });
    if(serverWords.length > 0 && serverRawSet.size > 0){
      allWords = allWords.filter(w => serverRawSet.has(w.rawLine));
      orderQueue = (Array.isArray(st.orderQueue) ? st.orderQueue.filter(r => serverRawSet.has(r)) : []);
      masteredFinal = (Array.isArray(st.masteredFinal) ? st.masteredFinal.filter(r => serverRawSet.has(r)) : []);
      practiceHistory = (Array.isArray(st.practiceHistory) ? st.practiceHistory.filter(r => serverRawSet.has(r)) : []);
      roundMastered = (Array.isArray(st.roundMastered) ? st.roundMastered.filter(r => serverRawSet.has(r)) : []);
      practiceAccum = (Array.isArray(st.practiceAccum) ? st.practiceAccum.filter(r => serverRawSet.has(r)) : []);
      practiceOrder = (Array.isArray(st.practiceOrder) ? st.practiceOrder.filter(r => serverRawSet.has(r)) : []);
      const changedWords = [];
      allWords.forEach((existingWord, index) => {
        if(serverRawSet.has(existingWord.rawLine)){
          const serverWord = serverWordsByRaw.get(existingWord.rawLine);
          if(JSON.stringify(existingWord.rus) !== JSON.stringify(serverWord.rus) || JSON.stringify(existingWord.arabParts) !== JSON.stringify(serverWord.arabParts)){
            allWords[index] = serverWord;
            changedWords.push(serverWord.rawLine);
          }
        }
      });
      changedWords.forEach(rawLine => {
        masteredFinal = masteredFinal.filter(r => r !== rawLine);
        practiceHistory = practiceHistory.filter(r => r !== rawLine);
        roundMastered = roundMastered.filter(r => r !== rawLine);
        practiceAccum = practiceAccum.filter(r => r !== rawLine);
        practiceOrder = practiceOrder.filter(r => r !== rawLine);
        if(!orderQueue.includes(rawLine)) orderQueue.push(rawLine);
      });
    } else {
      orderQueue = st.orderQueue || [];
      masteredFinal = st.masteredFinal || [];
      practiceHistory = st.practiceHistory || [];
      roundMastered = st.roundMastered || [];
      practiceAccum = st.practiceAccum || [];
      practiceOrder = st.practiceOrder || [];
    }
    phase = st.phase || 'learn';
    currentRaw = (st.currentRaw && serverRawSet.has(st.currentRaw)) ? st.currentRaw : null;
  } else {
    if(serverWords.length > 0){
      allWords = serverWords.slice();
      masteredFinal = []; practiceHistory = []; roundMastered = []; practiceAccum = []; practiceOrder = [];
      phase = 'learn'; currentRaw = null;
      orderQueue = allWords.map(w=>w.rawLine);
      shuffle(orderQueue);
    }
  }
  updateStats();
  saveState().catch(e => console.warn('Save failed:', e));
}

/* ---------- UI helpers ---------- */
function updateStats(){
  statTotal.textContent = allWords.length;
  statMastered.textContent = masteredFinal.length;
  statRemaining.textContent = orderQueue.length;
  statPhase.textContent = phase === 'learn' ? '–ó–∞—É—á–∏–≤–∞–Ω–∏–µ' : (phase === 'practice' ? '–ü—Ä–∞–∫—Ç–∏–∫–∞' : '‚Äî');
}
function showMessage(t){ messageDiv.textContent = t || ''; }

/* ---------- –ó–∞—É—á–∏–≤–∞–Ω–∏–µ ---------- */
function showNextLearn(){
  phase = 'learn';
  learnControls.classList.remove('hidden');
  practiceArea.classList.add('hidden');
  updateStats();
  if(orderQueue.length === 0){
    if(practiceAccum.length >= BATCH_SIZE){
      startPractice();
      return;
    }
    arabicDiv.textContent = '–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞.';
    showMessage('–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Å–±—Ä–æ—Å—å—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å.');
    return;
  }
  currentRaw = orderQueue[0];
  const obj = allWords.find(w=>w.rawLine===currentRaw) || {rus:[], arabParts:[]};
  arabicDiv.textContent = obj.arabFull || (obj.arabParts||[]).join(' - ') || '[–Ω–µ—Ç –∞—Ä–∞–±—Å–∫–æ–≥–æ]';
  showMessage('–ù–∞–∂–º–∏—Ç–µ ¬´–ó–Ω–∞—é¬ª –∏–ª–∏ ¬´–ù–µ –∑–Ω–∞—é¬ª.');
  saveState();
}

/* ---------- –ö–Ω–æ–ø–∫–∏ –∑–∞—É—á–∏–≤–∞–Ω–∏—è ---------- */
btnKnow.addEventListener('click', () => {
  if(!currentRaw) return;
  orderQueue.shift();
  if(!roundMastered.includes(currentRaw)) roundMastered.push(currentRaw);
  if(!practiceAccum.includes(currentRaw)) practiceAccum.push(currentRaw);
  currentRaw = null;
  if (practiceAccum.length >= BATCH_SIZE) {
    startPractice();
  } else {
    showNextLearn();
  }
});

btnDont.addEventListener('click', () => {
  if(!currentRaw) return;
  orderQueue.shift();
  if(!practiceAccum.includes(currentRaw)) practiceAccum.push(currentRaw);
  const obj = allWords.find(w=>w.rawLine===currentRaw) || parseLine(currentRaw);
  showDontKnowModal(obj);
  currentRaw = null;
});

/* ---------- Modal: "–ù–µ –∑–Ω–∞—é" ---------- */
function showDontKnowModal(obj){
  closeModal();
  const overlay = document.createElement('div'); overlay.className='overlay';
  const modal = document.createElement('div'); modal.className='modal';
  let html = '';
  const ar = obj.arabParts && obj.arabParts.length ? obj.arabParts : (obj.arabFull?obj.arabFull.split(/\s*-\s*/).map(s=>s.trim()):[]);
  if(obj.rus.length && ar.length && obj.rus.length === ar.length){
    for(let i=0;i<obj.rus.length;i++) html += `<div class="pair">${escapeHtml(obj.rus[i])} ‚Äî <span style="direction:rtl">${escapeHtml(ar[i])}</span></div>`;
  } else {
    const arabAll = ar.join(' - ');
    for(const r of obj.rus.length?obj.rus:['']) html += `<div class="pair">${escapeHtml(r)} ‚Äî <span style="direction:rtl">${escapeHtml(arabAll)}</span></div>`;
  }
  modal.innerHTML = `<div><strong>–ü–µ—Ä–µ–≤–æ–¥ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 15 —Å)</strong></div><div style="margin-top:8px">${html}</div>`;
  overlay.appendChild(modal);
  modalRoot.appendChild(overlay);
  modalTimer = setTimeout(()=>{
    closeModal();
    if(practiceAccum.length >= BATCH_SIZE){
      startPractice();
    } else {
      showNextLearn();
    }
  }, SHOW_ANSWER_MS);
}

/* ---------- Modal: –ø—Ä–∞–∫—Ç–∏–∫–∞ ‚Äî –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏ –º–µ–ª–∫–æ–π –æ—à–∏–±–∫–µ ---------- */
function showPracticeAnswerModal(obj, title = '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç', autoClose = true, onClose = null){
  closeModal();
  const overlay = document.createElement('div'); overlay.className='overlay';
  const modal = document.createElement('div'); modal.className='modal';
  let html = '';
  const ar = obj.arabParts && obj.arabParts.length ? obj.arabParts : (obj.arabFull?obj.arabFull.split(/\s*-\s*/).map(s=>s.trim()):[]);
  if(obj.rus.length && ar.length && obj.rus.length === ar.length){
    for(let i=0;i<obj.rus.length;i++) html += `<div class="pair">${escapeHtml(obj.rus[i])} ‚Äî <span style="direction:rtl">${escapeHtml(ar[i])}</span></div>`;
  } else {
    const arabAll = ar.join(' - ');
    for(const r of obj.rus.length?obj.rus:['']) html += `<div class="pair">${escapeHtml(r)} ‚Äî <span style="direction:rtl">${escapeHtml(arabAll)}</span></div>`;
  }
  modal.innerHTML = `<div><strong>${escapeHtml(title)}</strong></div><div style="margin-top:8px">${html}</div><div style="text-align:right;margin-top:12px"><button id="modal-close" class="button">–ó–∞–∫—Ä—ã—Ç—å (Esc)</button></div>`;
  overlay.appendChild(modal);
  modalRoot.appendChild(overlay);
  function cleanup(){ if(modalTimer){ clearTimeout(modalTimer); modalTimer=null; } document.removeEventListener('keydown', onKey); overlay.removeEventListener('click', onOverlay); const b=document.getElementById('modal-close'); if(b) b.removeEventListener('click', onBtn); if(overlay.parentNode) overlay.parentNode.removeChild(overlay); practiceInput.focus(); }
  function onKey(e){ if(e.key==='Escape') onBtn(); }
  function onOverlay(e){ if(e.target===overlay) onBtn(); }
  function onBtn(){ cleanup(); if(onClose) onClose(); else showNextPractice(); }
  document.addEventListener('keydown', onKey);
  overlay.addEventListener('click', onOverlay);
  const btn = document.getElementById('modal-close'); if(btn) btn.addEventListener('click', onBtn);
  if(autoClose) modalTimer = setTimeout(()=>{ onBtn(); }, SHOW_ANSWER_MS);
}

/* ---------- –ü—Ä–∞–∫—Ç–∏–∫–∞: —Å—Ç–∞—Ä—Ç ---------- */
function startPractice(){
  phase = 'practice';
  learnControls.classList.add('hidden');
  practiceArea.classList.remove('hidden');
  let newWords = practiceAccum.slice(0, BATCH_SIZE);
  let practiceWords = masteredFinal.filter(word => !roundMastered.includes(word));
  practiceOrder = newWords.concat(practiceWords);
  if(practiceWords.length > 1) {
    const shuffled = practiceWords.slice();
    shuffle(shuffled);
    practiceOrder = newWords.concat(shuffled);
  }
  practiceAccum = [];
  roundMastered = [];
  updateStats();
  showNextPractice();
  saveState();
}

/* ---------- showNextPractice ---------- */
function showNextPractice(){
  if(practiceOrder.length === 0){
    roundMastered = [];
    phase = 'learn';
    learnControls.classList.remove('hidden');
    practiceArea.classList.add('hidden');
    updateStats();
    showNextLearn();
    saveState();
    return;
  }
  currentRaw = practiceOrder.shift();
  const obj = allWords.find(w=>w.rawLine===currentRaw) || parseLine(currentRaw);
  arabicDiv.textContent = obj.arabFull || (obj.arabParts||[]).join(' - ') || '[–Ω–µ—Ç –∞—Ä–∞–±—Å–∫–æ–≥–æ]';
  practiceInput.value = '';
  practiceInput.focus();
  const isOld = masteredFinal.includes(currentRaw);
  if(isOld){
    oralAnswerBtn.classList.remove('hidden');
  } else {
    oralAnswerBtn.classList.add('hidden');
  }
  updateStats();
}

/* ---------- –£—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–ª–æ–≤) ---------- */
oralAnswerBtn.addEventListener('click', () => {
  if(!currentRaw || !masteredFinal.includes(currentRaw)) return;
  if(!roundMastered.includes(currentRaw)) roundMastered.push(currentRaw);
  showMessage('–ó–∞—Å—á–∏—Ç–∞–Ω–æ –∫–∞–∫ –≤–µ—Ä–Ω—ã–π (—É—Å—Ç–Ω–æ)');
  currentRaw = null;
  showNextPractice();
  saveState();
});

/* ---------- –ü—Ä–∞–∫—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ ---------- */
function enablePracticeControls(){ practiceSubmit.disabled=false; practiceSkip.disabled=false; practiceInput.disabled=false; practiceInput.focus(); }
function disablePracticeControls(){ practiceSubmit.disabled=true; practiceSkip.disabled=true; practiceInput.disabled=true; }

practiceSubmit.addEventListener('click', () => {
  if(!currentRaw) return;
  disablePracticeControls();
  try{
    const val = (practiceInput.value||'').trim();
    if(!val){ enablePracticeControls(); return; }
    const obj = allWords.find(w=>w.rawLine===currentRaw) || parseLine(currentRaw);
    const userNorm = normalizeRu(val);
    const exact = (obj.rus||[]).some(r => normalizeRu(r) === userNorm);
    const almost = !exact && (obj.rus||[]).some(r => isLastCharMistake(userNorm, normalizeRu(r)));
    const isOld = masteredFinal.includes(currentRaw);
    const markAsCorrect = () => {
      if(!roundMastered.includes(currentRaw)) roundMastered.push(currentRaw);
      if(!masteredFinal.includes(currentRaw)) masteredFinal.push(currentRaw);
      if(!practiceHistory.includes(currentRaw)) practiceHistory.push(currentRaw);
      updateStats();
      saveState();
    };
    if(exact){
      markAsCorrect();
      showMessage('–í–µ—Ä–Ω–æ ‚Äî –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –≤—ã—É—á–µ–Ω–Ω–æ–µ.');
      currentRaw = null;
      enablePracticeControls();
      showNextPractice();
    } else if(almost){
      markAsCorrect();
      showPracticeAnswerModal(obj, '–ú–µ–ª–∫–∞—è –æ—à–∏–±–∫–∞ ‚Äî –∑–∞—Å—á–∏—Ç–∞–Ω–æ', true, () => {
        currentRaw = null;
        enablePracticeControls();
        showNextPractice();
      });
    } else {
      if(isOld){
        practiceOrder.unshift(currentRaw);
      } else {
        orderQueue.unshift(currentRaw);
        if(masteredFinal.includes(currentRaw)){
          masteredFinal = masteredFinal.filter(r=>r!==currentRaw);
          practiceHistory = practiceHistory.filter(r=>r!==currentRaw);
        }
      }
      showPracticeAnswerModal(obj, '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ', true);
      currentRaw = null;
      enablePracticeControls();
    }
  }catch(e){ console.error(e); enablePracticeControls(); }
});

practiceInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); practiceSubmit.click(); }});

practiceSkip.addEventListener('click', () => {
  if(!currentRaw) return;
  const isOld = masteredFinal.includes(currentRaw);
  if(isOld){
    practiceOrder.unshift(currentRaw);
  } else {
    orderQueue.unshift(currentRaw);
    if(masteredFinal.includes(currentRaw)){
      masteredFinal = masteredFinal.filter(r => r !== currentRaw);
      practiceHistory = practiceHistory.filter(r => r !== currentRaw);
    }
  }
  currentRaw = null;
  showNextPractice();
  saveState();
});

/* ---------- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ ---------- */
btnAdd.addEventListener('click', async () => {
  try{
    const txt = await robustFetchWords();
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const serverWords = lines.map(parseLine);
    const existing = new Set(allWords.map(w => w.rawLine));
    let added = 0;
    for(const w of serverWords){
      if(!existing.has(w.rawLine)){
        allWords.push(w);
        orderQueue.push(w.rawLine);
        existing.add(w.rawLine);
        added++;
      }
    }
    if(added){
      shuffle(orderQueue);
      updateStats();
      alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤: ' + added);
      saveState();
    } else {
      alert('–ù–æ–≤—ã—Ö —Å–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
    }
  }catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message); }
});

/* ---------- –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ---------- */
function showResetModal() {
  closeModal();
  const overlay = document.createElement('div'); overlay.className = 'overlay';
  const modal = document.createElement('div'); modal.className = 'modal';
  modal.innerHTML = `
    <div><strong>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞</strong></div>
    <div style="margin-top:12px">–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å—ë –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–æ.</div>
    <div style="text-align:right;margin-top:16px">
      <button id="modal-cancel" style="margin-right:8px">–û—Ç–º–µ–Ω–∞</button>
      <button id="modal-confirm" class="btn-danger">–î–∞, —Å–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
  `;
  overlay.appendChild(modal);
  modalRoot.appendChild(overlay);
  const cleanup = () => { overlay.remove(); document.removeEventListener('keydown', onKey); };
  const onKey = e => { if(e.key==='Escape') cleanup(); };
  const onCancel = () => cleanup();
  const onConfirm = async () => {
    cleanup();
    
    // ‚úÖ –û—á–∏—â–∞–µ–º localStorage –°–†–ê–ó–£ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    try{
      localStorage.removeItem(PREFIX + 'state');
      localStorage.removeItem(PREFIX + 'state_backup');
      cleanOldBackups(0);
    }catch(e){ console.warn('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ localStorage:', e); }
    
    // ‚úÖ –°–†–ê–ó–£ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    orderQueue = allWords.map(w=>w.rawLine);
    shuffle(orderQueue);
    masteredFinal = [];
    practiceHistory = [];
    roundMastered = [];
    practiceAccum = [];
    practiceOrder = [];
    phase = 'learn';
    currentRaw = null;
    
    // ‚úÖ –°–†–ê–ó–£ –æ—á–∏—â–∞–µ–º UI
    arabicDiv.textContent = '';
    practiceInput.value = '';
    
    console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω (input), –≤—Å–µ–≥–æ —Å–ª–æ–≤:', allWords.length);
    
    // ‚úÖ –°–†–ê–ó–£ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
    showMessage('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω.');
    
    console.log('‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –∑–∞—É—á–∏–≤–∞–Ω–∏—è...');
    
    // ‚úÖ –°–†–ê–ó–£ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
    showNextLearn();
    
    // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    saveState();
    
    // ‚úÖ –£–¥–∞–ª—è–µ–º –∏–∑ Firebase –í –§–û–ù–ï (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI)
    if(window.firebaseEnabled && window.firestore && window.firebaseModules){
      safeFirebaseOperation(
        async () => {
          const docRef = window.firebaseModules.doc(
            window.firestore, 
            'users', USER_CODE, 
            'trainers', TRAINER_ID
          );
          await window.firebaseModules.deleteDoc(docRef);
          console.log('‚úì –£–¥–∞–ª–µ–Ω–æ –∏–∑ Firestore (input)');
        },
        '–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (input)',
        2
      ).catch(e => console.warn('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Firebase:', e));
    }
    
    // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥—É–∞ —Å –∫–æ–¥–æ–º (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    setTimeout(() => {
        window.dispatchEvent(new CustomEvent('progressReset'));
    }, 500);
  };
  document.addEventListener('keydown', onKey);
  document.getElementById('modal-cancel').addEventListener('click', onCancel);
  document.getElementById('modal-confirm').addEventListener('click', onConfirm);
}
btnReset.addEventListener('click', showResetModal);

/* ---------- bootstrap ---------- */
(async function bootstrap(){
  try{ 
    await initDictionary();
    screenMain.classList.remove('hidden');
    if(phase === 'practice'){
      learnControls.classList.add('hidden');
      practiceArea.classList.remove('hidden');
      showNextPractice();
    } else {
      practiceArea.classList.add('hidden');
      learnControls.classList.remove('hidden');
      showNextLearn();
    }
  }catch(e){ console.error(e); }
})();

window.addEventListener('beforeunload', saveState);
window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveState(); });
function closeModal(){ modalRoot.innerHTML=''; if(modalTimer){ clearTimeout(modalTimer); modalTimer=null; } }

</script>
</head>
<body>
  <a href="index.html" class="home-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
  <h1>–¢—Ä–µ–Ω–∞–∂—ë—Ä –ó–∞—É—á–∫–∞ + –ü—Ä–∞–∫—Ç–∏–∫–∞</h1>
  <div id="screen-main">
    <div class="stats">
      <div class="stat">–í—Å–µ–≥–æ: <span id="stat-total">0</span></div>
      <div class="stat">–û–∫–æ–Ω—á. –≤—ã—É—á–µ–Ω–æ: <span id="stat-mastered">0</span></div>
      <div class="stat">–í –æ—á–µ—Ä–µ–¥–∏: <span id="stat-remaining">0</span></div>
      <div class="stat">–§–∞–∑–∞: <span id="stat-phase">‚Äî</span></div>
    </div>
    <div id="arabic">‚Ä¶</div>
    <div id="learn-controls" class="controls">
      <button id="btn-know" class="btn-primary">–ó–Ω–∞—é</button>
      <button id="btn-dont">–ù–µ –∑–Ω–∞—é</button>
    </div>
    <div class="controls-vertical">
      <div class="controls">
        <button id="btn-reset" class="btn-danger">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        <button id="btn-add">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞</button>
      </div>
    </div>
    <div id="practice-area" class="hidden" style="margin-top:12px">
      <div style="margin-bottom:8px"><strong>–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º:</strong></div>
      <input id="practice-input" type="text" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥" />
      <div class="controls" style="margin-top:8px">
        <button id="practice-submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="practice-skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        <button id="oral-answer" class="btn-primary hidden">–û—Ç–≤–µ—Ç–∏–ª —É—Å—Ç–Ω–æ</button>
      </div>
    </div>
    <div id="message" class="small" style="margin-top:12px"></div>
  </div>
  <div id="modal-root"></div>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;color:#111;background:#fff;max-width:980px}
  .home-btn{display:inline-block;padding:10px 20px;margin-bottom:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;text-decoration:none;border-radius:8px;font-weight:bold;transition:opacity .3s}
  .home-btn:hover{opacity:.9}
  #arabic{direction:rtl;font-size:2.6rem;text-align:center;min-height:3.6em;padding:14px;border-radius:8px;border:1px solid #eee}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  .controls-vertical{display:block;text-align:center;margin-top:10px}
  .controls-vertical .controls{justify-content:center}
  button{padding:10px 12px;border-radius:8px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
  .btn-primary{background:#e6fff0;border-color:#b6f0c7}
  .btn-danger{background:#fff0f0;border-color:#f0b6b6}
  .small{font-size:0.95rem;color:#666;margin-top:8px;text-align:center}
  .hidden{display:none}
  input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  .stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:8px}
  .stat{background:#fafafa;padding:8px 12px;border-radius:8px;border:1px solid #f0f0f0}
  .overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;padding:16px;border-radius:8px;max-width:720px;width:92%;box-shadow:0 8px 30px rgba(0,0,0,0.2)}
  .modal .pair{margin-top:8px}
</style>
</body>
</html>
