<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –¢–µ—Ç—Ä–∞–¥—å - –ê—Ä–∞–±—Å–∫–∏–µ —Å–ª–æ–≤–∞</title>
    <script src="theme.js"></script>
    <link rel="stylesheet" href="theme.css">
    <script src="dua.js"></script>
    <script src="service-worker-register.js"></script>
    <script src="storage-protection.js"></script>
    <script src="sidebar-menu.js"></script>
    <script src="favorites.js"></script>
    <script src="streak.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            direction: ltr;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .mode-text {
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: background-color .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: #000;
            transition: transform .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
            border: 1px solid #333;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            width: 100%;
        }

        .words-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .word-row {
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
            background: white;
        }
        
        .fav-cell {
            width: 40px;
            text-align: center;
            vertical-align: middle;
        }
        
        .fav-star-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.2s;
            padding: 5px;
        }
        
        .fav-star-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }
        
        .fav-star-btn.active {
            opacity: 1;
        }

        .word-row:hover {
            background-color: #f9f9f9;
        }

        .word-row.revealed {
            background-color: #e8f5e9;
        }

        .word-row.swiping {
            transition: none;
            will-change: transform, opacity;
        }

        .word-row.error-swipe {
            background-color: #ffcdd2;
        }

        .word-cell {
            padding: 20px 15px;
            vertical-align: middle;
            overflow-wrap: break-word;
        }

        .word-cell.russian {
            text-align: left;
            color: #2c3e50;
            width: 50%;
            font-size: 18px;
            line-height: 1.8;
            word-wrap: break-word;
            word-break: break-word;
        }

        .word-cell.arabic {
            text-align: right;
            direction: rtl;
            color: #2c3e50;
            font-size: 30px;
            width: 50%;
            line-height: 1.6;
            padding: 28px 15px;
        }

        .word-cell.arabic.arabic-medium {
            font-size: 26px;
        }

        .word-cell.arabic.arabic-small {
            font-size: 22px;
        }

        .word-cell.arabic.arabic-very-small {
            font-size: 18px;
        }

        .word-cell.arabic.has-multiline {
            white-space: normal;
        }

        .word-cell.arabic:not(.has-multiline) {
            white-space: nowrap;
        }

        .word-cell.hidden {
            color: transparent;
            user-select: none;
            position: relative;
        }

        .word-cell.hidden::before {
            content: '**********';
            color: #999;
            position: absolute;
            left: 15px;
            font-size: 18px;
        }

        .word-cell.arabic.hidden::before {
            left: auto;
            right: 15px;
            font-size: 30px;
        }

        .word-cell.arabic.arabic-medium.hidden::before {
            font-size: 26px;
        }

        .word-cell.arabic.arabic-small.hidden::before {
            font-size: 22px;
        }

        .word-cell.arabic.arabic-very-small.hidden::before {
            font-size: 18px;
        }

        .pagination {
            text-align: center;
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .page-info {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .arrow-buttons {
            display: flex;
            gap: 10px;
        }

        .arrow-btn {
            background: white;
            color: #2196F3;
            border: 2px solid #2196F3;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .arrow-btn:hover {
            background: #2196F3;
            color: white;
        }

        .arrow-btn:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }

        .arrow-btn:disabled:hover {
            background: white;
            color: #ccc;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.3s;
            color: white;
        }

        .add-words-btn {
            background: #2196F3;
        }

        .add-words-btn:hover {
            background: #1976D2;
        }

        .reset-btn {
            background: #f44336;
        }

        .reset-btn:hover {
            background: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .modal-btn.cancel {
            background: #ccc;
            color: #333;
        }

        .modal-btn.cancel:hover {
            background: #bbb;
        }

        .modal-btn.confirm {
            background: #f44336;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #d32f2f;
        }

        .errors-section {
            margin-top: 40px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            border: 2px solid #ffc107;
        }

        .errors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .errors-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .errors-buttons {
            display: flex;
            gap: 10px;
        }

        .copy-btn, .restore-btn {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .copy-btn {
            background: #4CAF50;
        }

        .copy-btn:hover {
            background: #45a049;
        }

        .restore-btn {
            background: #FF9800;
        }

        .restore-btn:hover {
            background: #F57C00;
        }

        .errors-list {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .errors-list::-webkit-scrollbar {
            width: 12px;
        }

        .errors-list::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }

        .errors-list::-webkit-scrollbar-thumb {
            background: #000;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .errors-list::-webkit-scrollbar-thumb:hover {
            background: #222;
        }

        .error-item {
            padding: 8px 0;
            border-bottom: 1px solid #ffe08a;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .no-errors {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .hint {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-style: italic;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 40px;
            font-size: 16px;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
            color: #666;
            display: none;
        }

        .sync-status.show {
            display: block;
        }

        .sync-status.syncing {
            color: #2196F3;
        }

        .sync-status.synced {
            color: #4CAF50;
        }


        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
            }

            .word-cell.russian {
                font-size: 16px;
                padding: 18px 12px;
            }

            .word-cell.arabic {
                font-size: 26px;
                padding: 24px 12px;
            }

            .word-cell.arabic.arabic-medium {
                font-size: 22px;
            }

            .word-cell.arabic.arabic-small {
                font-size: 18px;
            }

            .word-cell.arabic.arabic-very-small {
                font-size: 16px;
            }

            .errors-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .errors-buttons {
                width: 100%;
                flex-direction: column;
            }

            .copy-btn, .restore-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåô –¢—Ä–µ–Ω–∞–∂–µ—Ä –¢–µ—Ç—Ä–∞–¥—å</h1>
        
        <div class="mode-toggle">
            <span class="mode-text" id="mode-text">–§–æ—Ä–º–∞—Ç: –ê–†–ë ‚Üí –†–£–°</span>
            <label class="switch">
                <input type="checkbox" id="mode-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="stats" id="stats">
            –í–°–ï–ì–û: 0, –û–°–¢–ê–õ–û–°–¨ –ü–†–û–ô–¢–ò: 0
        </div>

        <div id="words-list">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤...</div>
        </div>

        <div class="pagination">
            <div class="page-info" id="page-info"></div>
            <div class="arrow-buttons">
                <button class="arrow-btn" id="prev-page-btn" disabled>‚Üê</button>
                <button class="arrow-btn" id="next-page-btn" disabled>‚Üí</button>
            </div>
        </div>

        <div class="hint">
            üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥<br>
            üëâ –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ —Å –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ—à–∏–±–∫—É
        </div>

        <div class="action-buttons">
            <button class="action-btn add-words-btn" id="add-new-words-btn">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞</button>
            <button class="action-btn reset-btn" id="reset-progress-btn">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>

        <div class="errors-section">
            <div class="errors-header">
                <span class="errors-title">–û—à–∏–±–∫–∏:</span>
                <div class="errors-buttons">
                    <button class="restore-btn" id="restore-words-btn">–í–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–∞</button>
                    <button class="copy-btn" id="copy-errors-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏</button>
                </div>
            </div>
            <div class="errors-list" id="errors-list">
                <div class="no-errors">–û—à–∏–±–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>
            </div>
        </div>
    </div>

    <div class="sync-status" id="sync-status">
        ‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
    </div>

    <div class="modal" id="reset-modal">
        <div class="modal-content">
            <div class="modal-title">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞</div>
            <div class="modal-text">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?<br><br>
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–ª–æ–≤–∞ –∏ –æ—à–∏–±–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancel-reset-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn confirm" id="confirm-reset-btn">–î–∞, —Å–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ‚úÖ –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¢–û–† –¢–†–ï–ù–ê–ñ–ï–†–ê
        const TRAINER_ID = 'phases';
        
        // ‚úÖ –ü–†–ï–§–ò–ö–° –î–õ–Ø –≠–¢–û–ì–û –¢–†–ï–ù–ê–ñ–ï–†–ê
        const PREFIX = 'phases_';
        
        // ‚úÖ –û–ë–©–ò–ô –ö–û–î –î–õ–Ø –í–°–ï–• –¢–†–ï–ù–ê–ñ–ï–†–û–í
        const SHARED_CODE_KEY = 'userProgressCode';

        const firebaseConfig = {
            apiKey: "AIzaSyC2yC_BlLuP3dEzWUlWe57hhI4CezNZCy0",
            authDomain: "arab-learning-hub.firebaseapp.com",
            projectId: "arab-learning-hub",
            storageBucket: "arab-learning-hub.firebasestorage.app",
            messagingSenderId: "377334822830",
            appId: "1:377334822830:web:7cb045a81824741f427a3f",
            measurementId: "G-XBW1F1KGW3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // üîß –î–ª—è —Å–µ—Ç–µ–π —Å –ø—Ä–æ–∫—Å–∏/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏: —Ñ–æ—Ä—Å–∏—Ä—É–µ–º long-polling –∏ –æ—Ç–∫–ª—é—á–∞–µ–º stream
        db.settings({
            experimentalForceLongPolling: true,
            useFetchStreams: false
        });
        
        // ‚úÖ –î–µ–ª–∞–µ–º Firebase –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è streak.js
        window.firestore = db;
        window.firebaseEnabled = true;
        
        // ‚úÖ –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Firebase
        window.dispatchEvent(new CustomEvent('firebaseReady'));

        let words = [];
        let originalWords = [];
        let mode = 'ar-ru';
        let openedWordsMap = {};
        let errorWords = [];
        let currentPage = 0;
        const wordsPerPage = 100;
        let pageWordCounts = {};
        let userCode = '';
        let firebaseDataLoaded = false; // ‚úÖ –§–ª–∞–≥: –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase –∑–∞–≥—Ä—É–∂–µ–Ω—ã?
        let pendingSync = false;
        let syncTimeout = null;
        let nextWordId = 0;
        let resetVersion = getFromLocalStorage('resetVersion', 0); // üîÑ –í–µ—Ä—Å–∏—è —Å–±—Ä–æ—Å–∞ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

        let formattedCache = new Map();
        
        const wordsList = document.getElementById('words-list');
        const modeToggle = document.getElementById('mode-toggle');
        const modeText = document.getElementById('mode-text');
        const errorsList = document.getElementById('errors-list');
        const copyErrorsBtn = document.getElementById('copy-errors-btn');
        const restoreWordsBtn = document.getElementById('restore-words-btn');
        const addNewWordsBtn = document.getElementById('add-new-words-btn');
        const resetProgressBtn = document.getElementById('reset-progress-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const pageInfo = document.getElementById('page-info');
        const statsEl = document.getElementById('stats');
        const syncStatus = document.getElementById('sync-status');

        let touchStartX = 0;
        let touchStartY = 0;
        let touchCurrentX = 0;
        let touchCurrentY = 0;
        let isSwiping = false;
        let isValidSwipeStart = false;
        let currentSwipeRow = null;
        let rafId = null;

        // ‚úÖ –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –û–ë–©–ò–ú –ö–û–î–û–ú
        function getUserCode() {
            // ‚úÖ –ß–∏—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é (–∫–æ–¥ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
            try {
                return localStorage.getItem(SHARED_CODE_KEY) || '';
            } catch(e) {
                console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–¥–∞:', e);
                return '';
            }
        }

        function saveUserCode(code) {
            // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–ø—Ä—è–º—É—é (–∫–∞–∫ –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å index.html)
            try {
                localStorage.setItem(SHARED_CODE_KEY, code);
            } catch(e) {
                console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–¥–∞:', e);
            }
        }

        function generateWordId() {
            return `word_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function saveToLocalStorage(key, value) {
            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å timestamp –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            return safeLocalStorageSet(PREFIX + key, value, true);
        }

        function getFromLocalStorage(key, defaultValue = null) {
            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
            const result = safeLocalStorageGet(PREFIX + key);
            
            // ‚úÖ –û—á–∏—â–∞–µ–º timestamp –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–æ–Ω –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
            if (result && typeof result === 'object' && 'timestamp' in result && !Array.isArray(result)) {
                const { timestamp, ...cleanData } = result;
                // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è timestamp –æ—Å—Ç–∞–ª–∏—Å—å –¥—Ä—É–≥–∏–µ –∫–ª—é—á–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö
                if (Object.keys(cleanData).length > 0) {
                    // –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º _data, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞
                    if ('_data' in cleanData && Object.keys(cleanData).length === 1) {
                        return cleanData._data;
                    }
                    if ('_data' in cleanData) {
                        return cleanData._data;
                    }
                    return cleanData;
                }
            }

            // –ï—Å–ª–∏ safeLocalStorageGet –≤–µ—Ä–Ω—É–ª –æ–±—ë—Ä—Ç–∫—É —Ç–æ–ª—å–∫–æ —Å _data –±–µ–∑ timestamp
            if (result && typeof result === 'object' && '_data' in result && Object.keys(result).length === 1) {
                return result._data;
            }
            
            return result !== null ? result : defaultValue;
        }

        function removeFromLocalStorage(key) {
            localStorage.removeItem(PREFIX + key);
        }

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function showSyncStatus(message, type = 'syncing') {
            syncStatus.textContent = message;
            syncStatus.className = `sync-status show ${type}`;
            
            setTimeout(() => {
                syncStatus.classList.remove('show');
            }, 2000);
        }


        // ‚úÖ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° FIREBASE (–ü–û–î–ö–û–õ–õ–ï–ö–¶–ò–Ø)
        async function syncToFirebase() {
            if (!userCode) return;
            
            // ‚úÖ –ó–ê–©–ò–¢–ê: –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ Firebase –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Firebase –ø—É—Å—Ç—ã–º–∏
            if (!firebaseDataLoaded && Object.keys(openedWordsMap).length === 0) {
                console.log('‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞: –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ openedWords –ø—É—Å—Ç');
                console.log('   –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã–º–∏');
                return;
            }
            
            try {
                // ‚úÖ –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω—ã - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Firebase
                // (merge: true –ù–ï –¥–µ–ª–∞–µ—Ç –≥–ª—É–±–æ–∫–æ–µ —Å–ª–∏—è–Ω–∏–µ –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤!)
                
                if (!firebaseDataLoaded) {
                    console.log('‚ö†Ô∏è Firebase –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞');
                    console.log('   –ë—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ: timestamp, lastSync, lastUpdated');
                    
                    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —Ç–æ–ª—å–∫–æ –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
                    // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const minimalData = {
                        code: userCode,
                        trainerId: TRAINER_ID,
                        timestamp: Date.now(),
                        lastSync: new Date().toISOString(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        resetVersion
                    };
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ dot notation
                    // –≠—Ç–æ –î–û–ë–ê–í–ò–¢ —Å–ª–æ–≤–∞, –∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤–µ—Å—å –æ–±—ä–µ–∫—Ç
                    const updateData = { ...minimalData };
                    
                    if (Object.keys(openedWordsMap).length > 0) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º dot notation –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                        Object.keys(openedWordsMap).forEach(wordId => {
                            updateData[`openedWords.${wordId}`] = openedWordsMap[wordId];
                        });
                        console.log(`   + –î–æ–±–∞–≤–ª–µ–Ω–æ ${Object.keys(openedWordsMap).length} —Å–ª–æ–≤ —á–µ—Ä–µ–∑ dot notation`);
                    }
                    
                    const success = await safeFirebaseSave(
                        async () => {
                            return await db.collection('users')
                                   .doc(userCode)
                                   .collection('trainers')
                                   .doc(TRAINER_ID)
                                   .set(updateData, { merge: true });
                        },
                        PREFIX + 'firebase_backup',
                        updateData
                    );
                    
                    if (success) {
                        saveToLocalStorage('lastSync', new Date().toISOString());
                        console.log('‚úì –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
                        showSyncStatus('‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'synced');
                    }
                    return;
                }
                
                // ‚úÖ –ü–û–õ–ù–ê–Ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è - –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                console.log('‚úì –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (Firebase –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)');
                
                const data = {
                    code: userCode,
                    trainerId: TRAINER_ID,
                    initialWordCount: getFromLocalStorage('initialWordCount', 0),
                    openedWords: openedWordsMap,
                    errors: errorWords,
                    wordsOrder: words,
                    currentPage: currentPage,
                    pageWordCounts: pageWordCounts,
                    nextWordId: nextWordId,
                    resetVersion,
                    timestamp: Date.now(),
                    lastSync: new Date().toISOString(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };

                // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
                const success = await safeFirebaseSave(
                    async () => {
                        // ‚úÖ –ü–£–¢–¨: users/{code}/trainers/phases
                        return await db.collection('users')
                               .doc(userCode)
                               .collection('trainers')
                               .doc(TRAINER_ID)
                               .set(data, { merge: true });
                    },
                    PREFIX + 'firebase_backup',
                    data
                );
                
                if (success) {
                    saveToLocalStorage('lastSync', new Date().toISOString());
                    console.log('‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å Firebase (phases)');
                    showSyncStatus('‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'synced');
                } else {
                    showSyncStatus('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Firebase:', error);
                showSyncStatus('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
            }
        }

        function scheduleSyncToFirebase() {
            // –ë–æ–ª–µ–µ —á–∞—Å—Ç—ã–π —Ñ–æ–Ω–æ–≤–æ–π sync, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI
            if (syncTimeout) {
                clearTimeout(syncTimeout);
            }
            
            pendingSync = true;
            
            syncTimeout = setTimeout(() => {
                if (pendingSync) {
                    syncToFirebase();
                    pendingSync = false;
                }
            }, 18000);
        }

        // ‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ò–ó FIREBASE (–ü–û–î–ö–û–õ–õ–ï–ö–¶–ò–Ø)
        async function loadFromFirebase(code) {
            try {
                showSyncStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞...', 'syncing');
                
                // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ Firebase
                const data = await safeFirebaseLoad(
                    async () => {
                        // ‚úÖ –ü–£–¢–¨: users/{code}/trainers/phases
                        const doc = await db.collection('users')
                                           .doc(code)
                                           .collection('trainers')
                                           .doc(TRAINER_ID)
                                           .get();
                        
                        if (doc.exists) {
                            console.log('‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Firebase (phases)');
                            return doc.data();
                        }
                        return null;
                    },
                    PREFIX + 'firebase_backup'
                );
                
                if (data) {
                    let useFirebaseData = true;

                    const firebaseReset = data.resetVersion || 0;
                    const localReset = getFromLocalStorage('resetVersion', 0);
                    if (localReset > firebaseReset) {
                        // –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –Ω–æ–≤–µ–µ ‚Äì –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–±–ª–∞–∫–æ–º
                        resetVersion = localReset;
                        saveToLocalStorage('resetVersion', resetVersion);
                        useFirebaseData = false;
                        await syncToFirebase();
                        showSyncStatus('‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞)', 'synced');
                    } else if (firebaseReset > localReset) {
                        resetVersion = firebaseReset;
                        saveToLocalStorage('resetVersion', resetVersion);
                    }
                    // ‚úÖ –°–†–ê–í–ù–ò–í–ê–ï–ú TIMESTAMP: –ª–æ–∫–∞–ª—å–Ω—ã–µ VS Firebase
                    const firebaseTimestamp = data.timestamp || 0;
                    
                    // –ü–æ–ª—É—á–∞–µ–º timestamp –∏–∑ localStorage (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ–±—ë—Ä—Ç–∫—É —Å timestamp)
                    let localTimestamp = 0;
                    try {
                        const rawData = localStorage.getItem(PREFIX + 'openedWords');
                        if (rawData) {
                            const parsed = JSON.parse(rawData);
                            if (parsed && parsed.timestamp) {
                                localTimestamp = parsed.timestamp;
                            }
                        }
                    } catch(e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π timestamp:', e);
                    }
                    
                    if (localTimestamp > 0 && firebaseTimestamp > 0) {
                        // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ù–û–í–ï–ï - –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
                        if (localTimestamp > firebaseTimestamp) {
                            console.log(`üì± –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–µ (${new Date(localTimestamp).toLocaleString()} > ${new Date(firebaseTimestamp).toLocaleString()}), —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ Firebase...`);
                            useFirebaseData = false;
                            await syncToFirebase();
                        } else {
                            console.log(`‚òÅÔ∏è Firebase –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–µ (${new Date(firebaseTimestamp).toLocaleString()} >= ${new Date(localTimestamp).toLocaleString()}), –∑–∞–≥—Ä—É–∂–∞–µ–º...`);
                        }
                    } else if (firebaseTimestamp > 0) {
                        console.log('‚òÅÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase (–Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)');
                    } else if (localTimestamp > 0) {
                        console.log('üì± –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Firebase)');
                        useFirebaseData = false;
                        await syncToFirebase();
                    }
                    
                    if (useFirebaseData) {
                        const firebaseOpened = data.openedWords || {};
                        // üõ°Ô∏è –ù–µ —Ç–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å, –µ—Å–ª–∏ timestamps —Ä–∞–≤–Ω—ã/–±–ª–∏–∑–∫–∏
                        const localOpened = getFromLocalStorage('openedWords', {});
                        const mergedOpened = { ...firebaseOpened, ...localOpened };
                        const mergedAdded = Object.keys(mergedOpened).length > Object.keys(firebaseOpened).length;
                        
                        openedWordsMap = mergedOpened;
                        errorWords = data.errors || [];
                        pageWordCounts = data.pageWordCounts || {};
                        nextWordId = data.nextWordId || 0;
                        
                        // ‚úÖ –í–ê–ñ–ù–û: –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º initialWordCount –∏–∑ Firebase —Å —Ç–µ–∫—É—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ª–æ–≤
                        const firebaseWordCount = data.initialWordCount || 0;
                        const currentLocalWordCount = getFromLocalStorage('initialWordCount', 0);
                        const fileWordCount = getFromLocalStorage('fileWordCount', 0);
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –≤ words.txt –¥–æ–±–∞–≤–∏–ª–∏ —Å–ª–æ–≤–∞)
                        const actualWordCount = Math.max(firebaseWordCount, currentLocalWordCount, words.length, fileWordCount);
                        saveToLocalStorage('initialWordCount', actualWordCount);
                        
                        if (data.wordsOrder && data.wordsOrder.length > 0) {
                            // ‚öñÔ∏è –ë–µ—Ä–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –∏–∑ –æ–±–ª–∞–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ –∫–æ—Ä–æ—á–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ/—Ñ–∞–π–ª–æ–≤–æ–≥–æ
                            if (data.wordsOrder.length >= actualWordCount || data.wordsOrder.length >= words.length) {
                                words = data.wordsOrder;
                                saveToLocalStorage('wordsOrder', words);
                            } else {
                                console.warn(`‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º cloud wordsOrder (${data.wordsOrder.length}) ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ/–≤ —Ñ–∞–π–ª–µ –±–æ–ª—å—à–µ (${actualWordCount})`);
                                // –û—Ç–ø—Ä–∞–≤–∏–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º –Ω–∞–∑–∞–¥ –≤ –æ–±–ª–∞–∫–æ
                                scheduleSyncToFirebase();
                            }
                        }
                        
                        if (data.currentPage !== undefined) {
                            saveToLocalStorage('currentPage', data.currentPage);
                        }
                        
                        saveToLocalStorage('openedWords', openedWordsMap);
                        saveToLocalStorage('errors', errorWords);
                        saveToLocalStorage('pageWordCounts', pageWordCounts);
                        saveToLocalStorage('nextWordId', nextWordId);
                        saveToLocalStorage('lastSync', data.lastSync || new Date().toISOString());
                        saveToLocalStorage('resetVersion', resetVersion);
                        
                        if (mergedAdded) {
                            console.log('üìà –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–ª–æ–≤–∞ —Å Firebase, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é');
                            scheduleSyncToFirebase();
                        }
                        
                        showSyncStatus('‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞', 'synced');
                        
                        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ Firebase –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:', {
                            openedWordsCount: Object.keys(openedWordsMap).length,
                            errorsCount: errorWords.length,
                            currentPage: data.currentPage
                        });
                        
                        // ‚úÖ –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏!
                        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                        
                        firebaseDataLoaded = true; // ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase
                        console.log('‚úÖ Firebase –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞');
                        
                        // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                        updateStats();
                        renderWords();
                        renderErrors();
                    }
                    
                    return true;
                } else {
                    // ‚ö†Ô∏è –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ Firebase ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    // –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ü–û–õ–ù–£–Æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é!
                    // –ò–Ω–∞—á–µ wordsOrder, currentPage –∏ —Ç.–¥. –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Firebase
                    firebaseDataLoaded = true;
                    console.log('üì≠ –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) ‚Äî –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞');
                    return false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
                showSyncStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                return false;
            }
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function findSeparator(line) {
            const allSeparators = [' ‚Äî ', '‚Äî', ' ‚Äì ', '‚Äì', ' - ', '-'];
            
            let firstSeparator = null;
            let firstPosition = Infinity;
            
            allSeparators.forEach(sep => {
                const pos = line.indexOf(sep);
                if (pos !== -1 && pos < firstPosition) {
                    firstPosition = pos;
                    firstSeparator = sep;
                }
            });
            
            return firstSeparator;
        }

        function parseWordsFromText(text) {
            const lines = text.split('\n');
            const parsedWords = [];
            
            lines.forEach((line, index) => {
                line = line.trim().replace(/\r/g, '');
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–∏—Ä–µ: –ª—é–±—ã–µ ‚Üí –¥–µ—Ñ–∏—Å, –∑–∞—Ç–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥
                line = line.replace(/[\u2010-\u2015‚Äì‚Äî‚àí]+/g, '-');
                line = line.replace(/\s*-\s*/g, ' - ');
                
                if (!line || line.length < 3) return;
                
                const separator = findSeparator(line);
                if (!separator) {
                    return;
                }
                
                const parts = line.split(separator);
                if (parts.length < 2) return;
                
                const ru = parts[0].trim();
                const ar = parts.slice(1).join(separator).trim();
                
                if (ru && ar) {
                    parsedWords.push({ 
                        ru, 
                        ar, 
                        id: generateWordId()
                    });
                }
            });
            
            return parsedWords;
        }

        function detectChangesAndDeletes(newWordsFromFile, savedWords) {
            const changedWords = [];
            const wordsToRemove = [];
            
            const fileWordsMap = new Map();
            newWordsFromFile.forEach(word => {
                fileWordsMap.set(word.ru, word.ar);
            });
            
            const savedWordsMap = new Map();
            savedWords.forEach(word => {
                if (!savedWordsMap.has(word.ru)) {
                    savedWordsMap.set(word.ru, []);
                }
                savedWordsMap.get(word.ru).push(word);
            });
            
            savedWords.forEach(savedWord => {
                const fileAr = fileWordsMap.get(savedWord.ru);
                
                if (fileAr === undefined) {
                    console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: "${savedWord.ru} ‚Äî ${savedWord.ar}"`);
                    wordsToRemove.push(savedWord.id);
                }
                else if (fileAr !== savedWord.ar) {
                    console.log(`üìù –ò–∑–º–µ–Ω–µ–Ω–æ: "${savedWord.ru} ‚Äî ${savedWord.ar}" ‚Üí "${savedWord.ru} ‚Äî ${fileAr}"`);
                    wordsToRemove.push(savedWord.id);
                    
                    const existingChanged = changedWords.find(w => w.ru === savedWord.ru);
                    if (!existingChanged) {
                        changedWords.push({
                            ru: savedWord.ru,
                            ar: fileAr,
                            id: generateWordId()
                        });
                    }
                }
            });

            // üÜï –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ/–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ
            newWordsFromFile.forEach(fileWord => {
                if (!savedWordsMap.has(fileWord.ru)) {
                    const alreadyQueued = changedWords.find(w => w.ru === fileWord.ru && w.ar === fileWord.ar);
                    if (!alreadyQueued) {
                        console.log(`‚ûï –ù–æ–≤–æ–µ –∏–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: "${fileWord.ru} ‚Äî ${fileWord.ar}"`);
                        changedWords.push({
                            ru: fileWord.ru,
                            ar: fileWord.ar,
                            id: generateWordId()
                        });
                    }
                }
            });
            
            return { changedWords, wordsToRemove };
        }

        function applyChangesToWords(changedWords, wordsToRemove) {
            if (wordsToRemove.length === 0 && changedWords.length === 0) {
                return false;
            }
            
            const pageIndices = {};
            
            words = words.filter((word, index) => {
                const shouldRemove = wordsToRemove.includes(word.id);
                if (shouldRemove) {
                    const pageNum = getPageNumberForIndex(index);
                    pageIndices[pageNum] = (pageIndices[pageNum] || 0) + 1;
                    
                    delete openedWordsMap[word.id];
                    errorWords = errorWords.filter(e => e.word.id !== word.id);
                }
                return !shouldRemove;
            });
            
            for (const [pageNum, removedCount] of Object.entries(pageIndices)) {
                const page = parseInt(pageNum);
                const currentCount = pageWordCounts[page] || wordsPerPage;
                pageWordCounts[page] = Math.max(wordsPerPage, currentCount - removedCount);
                console.log(`üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page + 1}: —É–¥–∞–ª–µ–Ω–æ ${removedCount} —Å–ª–æ–≤`);
            }
            
            if (changedWords.length > 0) {
                const nextPageStartIndex = getPageStartIndex(currentPage + 1);
                words.splice(nextPageStartIndex, 0, ...changedWords);
                console.log(`‚úì ${changedWords.length} –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${currentPage + 2}`);
            }
            
            saveToLocalStorage('wordsOrder', words);
            saveToLocalStorage('pageWordCounts', pageWordCounts);
            saveToLocalStorage('openedWords', openedWordsMap);
            saveToLocalStorage('errors', errorWords);
            
            return true;
        }

        function validateProgress(currentWords) {
            let changesDetected = false;
            let removedCount = 0;
            let changedCount = 0;
            
            const currentWordsIds = new Set(currentWords.map(w => w.id));
            
            const newOpenedWordsMap = {};
            for (const [id, isOpened] of Object.entries(openedWordsMap)) {
                if (currentWordsIds.has(id)) {
                    newOpenedWordsMap[id] = isOpened;
                } else {
                    changedCount++;
                    changesDetected = true;
                }
            }
            
            const newErrorWords = errorWords.filter(error => {
                const exists = currentWordsIds.has(error.word.id);
                if (!exists) {
                    removedCount++;
                    changesDetected = true;
                }
                return exists;
            });
            
            if (changesDetected) {
                openedWordsMap = newOpenedWordsMap;
                errorWords = newErrorWords;
                
                saveToLocalStorage('openedWords', openedWordsMap);
                saveToLocalStorage('errors', errorWords);
                
                console.log(`üîÑ –û—á–∏—â–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${changedCount} –∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, ${removedCount} –∏–∑ –æ—à–∏–±–æ–∫`);
                
                scheduleSyncToFirebase();
            }
            
            return changesDetected;
        }

        async function loadWords() {
            try {
                // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å retry
                const text = await safeLoadWordsFile('words.txt', 3);
                
                if (!text) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
                }
                const allWordsFromFile = parseWordsFromText(text);
                const fileWordCount = allWordsFromFile.length;
                saveToLocalStorage('fileWordCount', fileWordCount);
                
                const savedWordsOrder = getFromLocalStorage('wordsOrder', null);
                const isFirstLoad = !Array.isArray(savedWordsOrder) || savedWordsOrder.length === 0;
                nextWordId = getFromLocalStorage('nextWordId', 0);
                const savedWordCount = getFromLocalStorage('initialWordCount', null);
                const observedWordCount = Array.isArray(savedWordsOrder) ? savedWordsOrder.length : 0;
                let knownCount = savedWordCount !== null
                    ? Math.max(savedWordCount, fileWordCount, observedWordCount)
                    : fileWordCount;
                knownCount = Math.min(knownCount, fileWordCount);
                if (isFirstLoad) {
                    knownCount = fileWordCount;
                }
                // –ï—Å–ª–∏ –≤ wordsOrder —É–∂–µ –µ—Å—Ç—å –≤–µ—Å—å –æ–±—ä—ë–º —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞),
                // –ø–æ–¥–Ω–∏–º–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –¥–æ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Ö–≤–æ—Å—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
                if (observedWordCount === fileWordCount && knownCount < fileWordCount) {
                    knownCount = fileWordCount;
                    saveToLocalStorage('initialWordCount', knownCount);
                }
                
                if (isFirstLoad) {
                    console.log('üÜï –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞ - –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–ª–æ–≤–∞');
                    // –ë–µ—Ä—ë–º –≤–µ—Å—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –±–µ–∑ –æ–±—Ä–µ–∑–∞–Ω–∏—è
                    originalWords = allWordsFromFile;
                    words = shuffleArray(originalWords);
                    pageWordCounts = {};
                    saveToLocalStorage('wordsOrder', words);
                    saveToLocalStorage('pageWordCounts', pageWordCounts);
                    saveToLocalStorage('nextWordId', nextWordId);
                    saveToLocalStorage('currentPage', 0);
                    // –§–∏–∫—Å–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–ª–æ–≤, –Ω–µ –ø–æ–≤—ã—à–∞—è –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    saveToLocalStorage('initialWordCount', knownCount);
                } else {
                    console.log('üìÇ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤');
                    words = savedWordsOrder.map(w => {
                        if (!w.id) {
                            w.id = generateWordId();
                        }
                        return w;
                    });
                    pageWordCounts = getFromLocalStorage('pageWordCounts', {});
                }
                
                // üõ†Ô∏è –§–∏–∫—Å —Å—Ç–∞—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–±—ä—ë–º –º–µ–Ω—å—à–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ,
                // –Ω–æ —Å–ª–æ–≤–∞ –≤ —Ñ–∞–π–ª–µ –Ω–µ –Ω–æ–≤—ã–µ (—Ö–≤–æ—Å—Ç –ø–æ—Ç–µ—Ä—è–Ω), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ
                if (savedWordCount !== null && savedWordCount < allWordsFromFile.length) {
                    const wordsSet = new Set(words.map(w => `${w.ru}|||${w.ar}`));
                    const missing = allWordsFromFile.filter(w => !wordsSet.has(`${w.ru}|||${w.ar}`));
                    if (missing.length > 0) {
                        console.log(`üìà –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –±–µ–∑ —Å–±—Ä–æ—Å–∞: ${missing.length}`);
                        words.push(...missing);
                        originalWords.push(...missing);
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                        const pageKeys = Object.keys(pageWordCounts).map(Number);
                        const lastPage = pageKeys.length ? Math.max(...pageKeys) : 0;
                        pageWordCounts[lastPage] = (pageWordCounts[lastPage] || wordsPerPage) + missing.length;
                        saveToLocalStorage('wordsOrder', words);
                        saveToLocalStorage('pageWordCounts', pageWordCounts);
                        saveToLocalStorage('initialWordCount', allWordsFromFile.length);
                    }
                }
                
                validateProgress(words);
                
                if (words.length === 0) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞');
                }
                
                updateStats();
                currentPage = getFromLocalStorage('currentPage', 0);
                renderWords();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤:', error);
                wordsList.innerHTML = '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤: ' + error.message + '</div>';
            }
        }

        async function checkAndApplyFileChanges(preloadedText = null) {
            try {
                // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å retry (–∏–ª–∏ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç)
                const text = preloadedText !== null ? preloadedText : await safeLoadWordsFile('words.txt', 3);
                if (!text) return;
                const allWordsFromFile = parseWordsFromText(text);
                
                const savedWordCount = getFromLocalStorage('initialWordCount', null);
                const fileWordCount = getFromLocalStorage('fileWordCount', allWordsFromFile.length);
                // ‚úÖ –ù–µ –∑–∞–Ω–∏–∂–∞–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–±—ä—ë–º: —É—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                const baseKnownCount = Math.max(
                    savedWordCount === null ? 0 : savedWordCount,
                    words.length,
                    fileWordCount
                );
                const effectiveSavedCount = Math.min(allWordsFromFile.length, baseKnownCount);
                const knownWords = allWordsFromFile.slice(0, effectiveSavedCount);
                
                const { changedWords, wordsToRemove } = detectChangesAndDeletes(knownWords, words);
                
                const hasChanges = applyChangesToWords(changedWords, wordsToRemove);
                
                if (hasChanges) {
                    validateProgress(words);
                    updateStats();
                    renderWords();
                    scheduleSyncToFirebase();
                    console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
                } else {
                    console.log('‚úì –ò–∑–º–µ–Ω–µ–Ω–∏–π –∏ —É–¥–∞–ª–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ');
                }

                // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–ª–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É–º–µ–Ω—å—à–∏–ª—Å—è (—É–¥–∞–ª–µ–Ω–∏—è)
                if (savedWordCount !== effectiveSavedCount) {
                    saveToLocalStorage('initialWordCount', effectiveSavedCount);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
                    saveToLocalStorage('wordsOrder', words);
                    scheduleSyncToFirebase();
                    console.log(`‚ÑπÔ∏è –û–±–Ω–æ–≤–ª—ë–Ω –ª–∏–º–∏—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–ª–æ–≤: ${effectiveSavedCount}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
            }
        }

        function getPageNumberForIndex(index) {
            let currentIndex = 0;
            let pageNum = 0;
            
            while (currentIndex <= index) {
                const pageSize = pageWordCounts[pageNum] || wordsPerPage;
                
                if (index < currentIndex + pageSize) {
                    return pageNum;
                }
                
                currentIndex += pageSize;
                pageNum++;
            }
            
            return pageNum;
        }

        // ‚úÖ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ï–ó –ú–û–î–ê–õ–ö–ò
        async function initialize() {
            userCode = getUserCode();
            
            if (!userCode) {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥, –Ω–æ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                userCode = generateCode();
                saveUserCode(userCode);
                console.log('üÜï –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–¥:', userCode);
                
                await loadWords();
                await checkAndApplyFileChanges();
                await syncToFirebase();
            } else {
                console.log('üë§ –ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userCode);
                
                openedWordsMap = getFromLocalStorage('openedWords', {});
                errorWords = getFromLocalStorage('errors', []);
                pageWordCounts = getFromLocalStorage('pageWordCounts', {});
                nextWordId = getFromLocalStorage('nextWordId', 0);
                
                renderErrors();
                
                await loadWords();
                
                await loadFromFirebase(userCode);
                await checkAndApplyFileChanges();
                
                validateProgress(words);
                
                renderErrors();
                updateStats();
                currentPage = getFromLocalStorage('currentPage', 0);
                renderWords();
            }
        }

        resetProgressBtn.addEventListener('click', function() {
            document.getElementById('reset-modal').classList.add('show');
        });

        document.getElementById('cancel-reset-btn').addEventListener('click', function() {
            document.getElementById('reset-modal').classList.remove('show');
        });

        document.getElementById('confirm-reset-btn').addEventListener('click', async function() {
            try {
                // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å retry
                const text = await safeLoadWordsFile('words.txt', 3);
                if (!text) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
                const allWords = parseWordsFromText(text);
                
                // –ü—Ä–∏ —Å–±—Ä–æ—Å–µ —Ç—è–Ω–µ–º –≤—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ —Ü–µ–ª–∏–∫–æ–º (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ)
                originalWords = allWords;
                words = shuffleArray(allWords);

                // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–ª–æ–≤ –Ω–∞ –ø–æ–ª–Ω—ã–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º –ü–ï–†–ï–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                const fullWordCount = allWords.length;
                saveToLocalStorage('initialWordCount', fullWordCount);
                saveToLocalStorage('wordsOrder', words);
                saveToLocalStorage('currentPage', 0);
                resetVersion = Date.now();
                saveToLocalStorage('resetVersion', resetVersion);
                
                openedWordsMap = {};
                errorWords = [];
                currentPage = 0;
                pageWordCounts = {};
                nextWordId = 0;
                
                saveToLocalStorage('openedWords', openedWordsMap);
                saveToLocalStorage('errors', errorWords);
                saveToLocalStorage('pageWordCounts', pageWordCounts);
                saveToLocalStorage('nextWordId', nextWordId);
                
                // ‚úÖ –°–ù–ê–ß–ê–õ–ê –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                document.getElementById('reset-modal').classList.remove('show');
                
                // ‚úÖ –°–†–ê–ó–£ –æ–±–Ω–æ–≤–ª—è–µ–º UI
                renderErrors();
                updateStats();
                renderWords();
                
                console.log('‚úì –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω');
                
                // ‚úÖ –°–†–ê–ó–£ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥—É–∞ —Å –∫–æ–¥–æ–º
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ progressReset —á–µ—Ä–µ–∑ 500–º—Å...');
                setTimeout(() => {
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ progressReset —Å–µ–π—á–∞—Å!');
                    window.dispatchEvent(new CustomEvent('progressReset'));
                }, 500);
                
                // ‚úÖ Firebase —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –í –§–û–ù–ï (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI)
                syncToFirebase().catch(e => console.warn('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Firebase:', e));
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
                document.getElementById('reset-modal').classList.remove('show');
            }
        });

        addNewWordsBtn.addEventListener('click', async function() {
            try {
                // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å retry
                const text = await safeLoadWordsFile('words.txt', 3);
                if (!text) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
                const allWords = parseWordsFromText(text);
                
                const savedWordCount = getFromLocalStorage('initialWordCount', 0);
                
                if (allWords.length <= savedWordCount) {
                    alert('–ù–æ–≤—ã—Ö —Å–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                
                const newWords = allWords.slice(savedWordCount);
                console.log(`‚ûï –ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤: ${newWords.length}`);
                
                const shuffledNewWords = shuffleArray(newWords);
                
                shuffledNewWords.forEach(word => {
                    words.push(word);
                    originalWords.push(word);
                });
                
                saveToLocalStorage('initialWordCount', allWords.length);
                saveToLocalStorage('wordsOrder', words);
                
                formattedCache.clear();
                
                updateStats();
                renderWords();
                scheduleSyncToFirebase();
                alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤: ${newWords.length}`);
                
                const originalText = this.textContent;
                this.textContent = `‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ ${newWords.length} —Å–ª–æ–≤!`;
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤');
            }
        });

        function updateStats() {
            const total = words.length;
            const completed = Object.keys(openedWordsMap).length;
            const remaining = total - completed;
            statsEl.textContent = `–í–°–ï–ì–û: ${total}, –û–°–¢–ê–õ–û–°–¨ –ü–†–û–ô–¢–ò: ${remaining}`;
        }

        function addError(word) {
            const errorEntry = {
                word: { ru: word.ru, ar: word.ar, id: word.id },
                text: `${word.ru} ‚Äî ${word.ar}`
            };
            
            if (!errorWords.find(e => e.word.id === word.id)) {
                errorWords.push(errorEntry);
                saveToLocalStorage('errors', errorWords);
                renderErrors();
                scheduleSyncToFirebase();
            }
        }

        function renderErrors() {
            if (errorWords.length === 0) {
                errorsList.innerHTML = '<div class="no-errors">–û—à–∏–±–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            } else {
                errorsList.innerHTML = errorWords.map(error => 
                    `<div class="error-item">${error.text}</div>`
                ).join('');
            }
        }

        copyErrorsBtn.addEventListener('click', function() {
            if (errorWords.length === 0) {
                alert('–ù–µ—Ç –æ—à–∏–±–æ–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            const text = errorWords.map(e => e.text).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const originalText = this.textContent;
                this.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            });
        });

        restoreWordsBtn.addEventListener('click', function() {
            if (errorWords.length === 0) {
                alert('–ù–µ—Ç –æ—à–∏–±–æ–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞');
                return;
            }
            
            console.log(`–í–æ–∑–≤—Ä–∞—â–∞–µ–º ${errorWords.length} —Å–ª–æ–≤ –≤ –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${currentPage}`);
            
            const pageEndIndex = getPageEndIndex(currentPage);
            
            console.log(`–í—Å—Ç–∞–≤–ª—è–µ–º —Å–ª–æ–≤–∞ –ø–æ—Å–ª–µ –ø–æ–∑–∏—Ü–∏–∏ ${pageEndIndex}`);
            
            const wordsToRestore = errorWords.map(e => {
                return {
                    ru: e.word.ru,
                    ar: e.word.ar,
                    id: generateWordId()
                };
            });
            
            words.splice(pageEndIndex + 1, 0, ...wordsToRestore);
            
            const currentCount = pageWordCounts[currentPage] || wordsPerPage;
            pageWordCounts[currentPage] = currentCount + wordsToRestore.length;
            
            errorWords = [];
            
            saveToLocalStorage('errors', errorWords);
            saveToLocalStorage('wordsOrder', words);
            saveToLocalStorage('pageWordCounts', pageWordCounts);
            
            renderErrors();
            updateStats();
            renderWords();
            scheduleSyncToFirebase();
            
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 100);
            
            const originalText = this.textContent;
            this.textContent = '‚úì –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ!';
            setTimeout(() => {
                this.textContent = originalText;
            }, 2000);
        });

        function getPageEndIndex(pageNum) {
            let startIndex = 0;
            
            for (let i = 0; i < pageNum; i++) {
                const pageSize = pageWordCounts[i] || wordsPerPage;
                startIndex += pageSize;
            }
            
            const currentPageSize = pageWordCounts[pageNum] || wordsPerPage;
            
            const endIndex = startIndex + currentPageSize - 1;
            
            return Math.min(endIndex, words.length - 1);
        }

        function getPageStartIndex(pageNum) {
            let startIndex = 0;
            
            for (let i = 0; i < pageNum; i++) {
                const pageSize = pageWordCounts[i] || wordsPerPage;
                startIndex += pageSize;
            }
            
            return startIndex;
        }

        function formatRussian(text) {
            if (formattedCache.has(text)) {
                return formattedCache.get(text);
            }
            
            const separator = findSeparator(text);
            let result;
            
            if (separator) {
                const parts = text.split(separator);
                result = parts.join('<br>');
            } else {
                result = text;
            }
            
            formattedCache.set(text, result);
            return result;
        }

        function formatArabicWithLineBreaks(text) {
            const allSeparators = [' ‚Äî ', '‚Äî', ' ‚Äì ', '‚Äì', ' - ', '-'];
            let separator = null;
            
            for (const sep of allSeparators) {
                if (text.includes(sep)) {
                    separator = sep;
                    break;
                }
            }
            
            if (!separator) return text;
            
            const parts = text.split(separator);
            const separatorCount = parts.length - 1;
            
            if (separatorCount <= 2) {
                return text;
            }
            
            if (separatorCount === 3) {
                return parts[0] + separator + parts[1] + '<br>' + 
                       parts[2] + separator + parts[3];
            }
            
            if (separatorCount === 4) {
                return parts[0] + separator + parts[1] + separator + parts[2] + '<br>' + 
                       parts[3] + separator + parts[4];
            }
            
            if (separatorCount === 5) {
                return parts[0] + separator + parts[1] + separator + parts[2] + '<br>' + 
                       parts[3] + separator + parts[4] + separator + parts[5];
            }
            
            if (separatorCount >= 6) {
                const firstLine = parts.slice(0, 3).join(separator);
                const secondLine = parts.slice(3, 6).join(separator);
                const remaining = parts.slice(6).join(separator);
                
                if (remaining) {
                    return firstLine + '<br>' + secondLine + '<br>' + remaining;
                } else {
                    return firstLine + '<br>' + secondLine;
                }
            }
            
            return text;
        }

        function getArabicSizeClass(text) {
            const length = text.length;
            
            if (length > 45) {
                return 'arabic-very-small';
            } else if (length > 30) {
                return 'arabic-small';
            } else if (length > 17) {
                return 'arabic-medium';
            }
            
            return '';
        }

        function isWordOpened(word) {
            return openedWordsMap[word.id] === true;
        }

        function markWordAsOpened(word) {
            openedWordsMap[word.id] = true;
            saveToLocalStorage('openedWords', openedWordsMap);
            scheduleSyncToFirebase();
        }

        function isWordInErrors(word) {
            return errorWords.some(error => error.word.id === word.id);
        }

        function getVisibleWords() {
            const visibleWords = [];
            
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                
                if (!isWordInErrors(word)) {
                    visibleWords.push({ word, originalIndex: i });
                }
            }
            
            return visibleWords;
        }

        function renderWords() {
            wordsList.innerHTML = '';
            
            if (words.length === 0) {
                wordsList.innerHTML = '<div class="loading">–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                return;
            }

            const startIndex = getPageStartIndex(currentPage);
            const endIndex = getPageEndIndex(currentPage) + 1;
            
            console.log(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}: –∏–Ω–¥–µ–∫—Å—ã ${startIndex}-${endIndex-1}, —Å–ª–æ–≤: ${endIndex - startIndex}`);
            
            const currentWords = [];
            
            for (let i = startIndex; i < endIndex && i < words.length; i++) {
                const word = words[i];
                
                if (!isWordInErrors(word)) {
                    currentWords.push({ word, originalIndex: i });
                }
            }

            const table = document.createElement('table');
            table.className = 'words-table';
            
            currentWords.forEach((item) => {
                const word = item.word;
                const row = document.createElement('tr');
                row.className = 'word-row';
                const isOpened = isWordOpened(word);
                
                if (isOpened) {
                    row.classList.add('revealed');
                }
                
                const formattedRu = formatRussian(word.ru);
                const formattedAr = formatArabicWithLineBreaks(word.ar);
                const hasMultiline = formattedAr.includes('<br>');
                const sizeClass = getArabicSizeClass(word.ar);
                
                row.dataset.wordIndex = item.originalIndex;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º rawLine –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                const rawLine = `${word.ru} - ${word.ar}`;
                const isFav = typeof isFavorite === 'function' && (
                    isFavorite(rawLine) ||
                    (typeof isFavoriteByArabic === 'function' && isFavoriteByArabic(word.ar))
                );
                
                const starCell = `<td class="fav-cell"><button class="fav-star-btn ${isFav ? 'active' : ''}" onclick="toggleWordFavorite(event, ${item.originalIndex})" title="${isFav ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">${isFav ? '‚≠ê' : '‚òÜ'}</button></td>`;
                
                if (mode === 'ar-ru') {
                    row.innerHTML = `
                        ${starCell}
                        <td class="word-cell russian ${isOpened ? '' : 'hidden'}" data-ru="${word.ru}">${isOpened ? formattedRu : ''}</td>
                        <td class="word-cell arabic ${sizeClass} ${hasMultiline ? 'has-multiline' : ''}">${formattedAr}</td>
                    `;
                } else {
                    row.innerHTML = `
                        ${starCell}
                        <td class="word-cell russian">${formattedRu}</td>
                        <td class="word-cell arabic ${sizeClass} ${hasMultiline ? 'has-multiline' : ''} ${isOpened ? '' : 'hidden'}" data-ar="${word.ar}">${isOpened ? formattedAr : ''}</td>
                    `;
                }

                table.appendChild(row);
            });

            wordsList.appendChild(table);
            updatePagination();
        }

        function updatePagination() {
            let totalPages = 0;
            let accumulatedWords = 0;
            let pageNum = 0;
            
            while (accumulatedWords < words.length) {
                const pageSize = pageWordCounts[pageNum] || wordsPerPage;
                accumulatedWords += pageSize;
                totalPages++;
                pageNum++;
            }
            
            prevPageBtn.disabled = currentPage === 0;
            nextPageBtn.disabled = (currentPage + 1) >= totalPages;

            const startIndex = getPageStartIndex(currentPage);
            const endIndex = getPageEndIndex(currentPage) + 1;
            const wordsOnPage = Math.min(endIndex - startIndex, words.length - startIndex);
            
            pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage + 1} –∏–∑ ${totalPages} (—Å–ª–æ–≤: ${wordsOnPage})`;
        }

        nextPageBtn.addEventListener('click', function() {
            currentPage++;
            saveToLocalStorage('currentPage', currentPage);
            renderWords();
            scheduleSyncToFirebase();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 0) {
                currentPage--;
                saveToLocalStorage('currentPage', currentPage);
                renderWords();
                scheduleSyncToFirebase();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        wordsList.addEventListener('click', function(e) {
            if (isSwiping) return;
            
            const row = e.target.closest('.word-row');
            if (!row) return;
            
            const wordIndex = parseInt(row.dataset.wordIndex);
            const word = words[wordIndex];
            if (!word) return;
            
            const hiddenCell = row.querySelector('.hidden');
            
            if (hiddenCell) {
                let text;
                const sizeClass = getArabicSizeClass(word.ar);
                
                if (hiddenCell.classList.contains('russian')) {
                    text = hiddenCell.dataset.ru;
                    hiddenCell.innerHTML = formatRussian(text);
                } else {
                    text = hiddenCell.dataset.ar;
                    hiddenCell.innerHTML = formatArabicWithLineBreaks(text);
                    
                    if (formatArabicWithLineBreaks(text).includes('<br>')) {
                        hiddenCell.classList.add('has-multiline');
                    }
                }
                
                hiddenCell.classList.remove('hidden');
                row.classList.add('revealed');
                
                markWordAsOpened(word);
                if(typeof recordWordAnswer === 'function') recordWordAnswer(); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–ª—è —Å–µ—Ä–∏–∏ –¥–Ω–µ–π
                updateStats();
            }
        });

        wordsList.addEventListener('touchstart', function(e) {
            const row = e.target.closest('.word-row');
            if (!row) return;
            
            currentSwipeRow = row;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            
            const rowRect = row.getBoundingClientRect();
            const touchRelativeX = touchStartX - rowRect.left;
            const rowWidth = rowRect.width;
            
            isValidSwipeStart = (touchRelativeX / rowWidth) <= 0.25;
            
            isSwiping = false;
        }, { passive: true });

        wordsList.addEventListener('touchmove', function(e) {
            if (!currentSwipeRow || !touchStartX || !isValidSwipeStart) return;
            
            touchCurrentX = e.touches[0].clientX;
            touchCurrentY = e.touches[0].clientY;
            
            const diffX = touchCurrentX - touchStartX;
            const diffY = touchCurrentY - touchStartY;
            
            const isHorizontal = Math.abs(diffX) > Math.abs(diffY) * 2;
            
            if (Math.abs(diffX) > 10 && isHorizontal) {
                isSwiping = true;
                currentSwipeRow.classList.add('swiping');
                
                if (rafId) cancelAnimationFrame(rafId);
                
                rafId = requestAnimationFrame(() => {
                    if (diffX > 0) {
                        currentSwipeRow.style.transform = `translateX(${diffX}px)`;
                        currentSwipeRow.style.opacity = 1 - (diffX / 200);
                        
                        if (diffX > 50) {
                            currentSwipeRow.classList.add('error-swipe');
                        } else {
                            currentSwipeRow.classList.remove('error-swipe');
                        }
                    }
                });
            }
        }, { passive: true });

        wordsList.addEventListener('touchend', function(e) {
            if (!currentSwipeRow) return;
            
            if (!isSwiping || !isValidSwipeStart) {
                currentSwipeRow = null;
                touchStartX = 0;
                touchStartY = 0;
                isValidSwipeStart = false;
                return;
            }
            
            const diffX = touchCurrentX - touchStartX;
            const diffY = touchCurrentY - touchStartY;
            const isHorizontal = Math.abs(diffX) > Math.abs(diffY) * 2;
            
            if (diffX > 120 && isHorizontal && isValidSwipeStart) {
                const wordIndex = parseInt(currentSwipeRow.dataset.wordIndex);
                const word = words[wordIndex];
                if (word) {
                    addError(word);
                }
                
                if (currentSwipeRow) {
                    currentSwipeRow.style.transform = '';
                    currentSwipeRow.style.opacity = '';
                    currentSwipeRow.style.transition = '';
                    currentSwipeRow.classList.remove('swiping', 'error-swipe');
                }
            } else {
                currentSwipeRow.style.transform = '';
                currentSwipeRow.style.opacity = '';
                currentSwipeRow.classList.remove('swiping', 'error-swipe');
            }
            
            currentSwipeRow = null;
            touchStartX = 0;
            touchStartY = 0;
            touchCurrentX = 0;
            touchCurrentY = 0;
            isValidSwipeStart = false;
            
            setTimeout(() => {
                isSwiping = false;
            }, 100);
        }, { passive: true });

        modeToggle.addEventListener('change', function() {
            mode = this.checked ? 'ru-ar' : 'ar-ru';
            
            if (mode === 'ar-ru') {
                modeText.textContent = '–§–æ—Ä–º–∞—Ç: –ê–†–ë ‚Üí –†–£–°';
            } else {
                modeText.textContent = '–§–æ—Ä–º–∞—Ç: –†–£–° ‚Üí –ê–†–ë';
            }
            
            renderWords();
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        function toggleWordFavorite(event, wordIndex) {
            event.stopPropagation();
            const word = words[wordIndex];
            if (!word) return;
            
            const rawLine = `${word.ru} - ${word.ar}`;
            const isNowFav = typeof toggleFavorite === 'function' && toggleFavorite(rawLine);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            const btn = event.target;
            btn.classList.toggle('active', isNowFav);
            btn.innerHTML = isNowFav ? '‚≠ê' : '‚òÜ';
            btn.title = isNowFav ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
        }

        initialize();
    </script>
</body>
</html>
